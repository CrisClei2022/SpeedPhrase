<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpeedPhrase</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    .video-container, .words-container, .formed-sentence, .controls { margin-top: 20px; }
    .word { display: inline-block; margin: 5px; padding: 10px 15px; background: #eee; border-radius: 5px; cursor: pointer; }
    .word.correct { background-color: #c8f7c5; }
    .word.incorrect { background-color: #f7c5c5; }
    .formed-sentence { font-weight: bold; margin-top: 10px; }
    button { margin-top: 10px; padding: 10px 20px; }
    .video-grid-container {
  padding: 20px;
}

    .video-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .video-card {
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 200px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .video-card:hover {
      transform: scale(1.03);
    }

  </style>
</head>
<body>

<main style="padding-bottom: 80px;">
  <!-- Header da p√°gina com t√≠tulo -->
  <header>
    <div id="breadcrumb"></div>
  </header>
  
  <section id="avulsas-section" class="video-grid-container">
    <div id="avulsas-grid" class="video-grid"></div>
  </section>

  <section id="trilha-section" class="video-grid-container hidden">
    <div id="trilha-grid" class="video-grid"></div>
  </section>

  <!-- Se√ß√£o do timer, separado do header -->
  <section id="timerSection" style="margin-top: 10px; font-weight: bold;">
    <div id="totalTime">‚è±Ô∏è Tempo total: 0.00s</div>
    <div id="liveTotalTime">üïí Tempo total ao vivo: 0.00s</div>
    <div id="timer">‚è≥ 0s</div>
  </section>

  <!-- Se√ß√£o do v√≠deo e controles -->
  <section id="videoSection" style="margin-top: 20px;">
    <div class="video-container">
      <video id="video" width="70%" height="340" controls>
        <source src="https://f005.backblazeb2.com/file/Avulsas/Im_Gonna_Be_-_500_Miles.mp4" type="video/mp4" />
      </video>
    </div>
    <div class="controls" style="margin-top: 10px;">
      <button onclick="playCurrentSubtitle()">‚ñ∂Ô∏è Tocar trecho</button>
    </div>
  </section>

  <!-- Se√ß√£o da frase formada -->
  <section id="formedSentenceSection" style="margin-top: 20px;">
    <div class="formed-sentence" id="formedSentence"></div>
  </section>

  <!-- Se√ß√£o das palavras embaralhadas -->
  <section id="shuffledWordsSection" style="margin-top: 20px;">
    <div class="words-container" id="shuffledWords"></div>
  </section>
</main>

<footer style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #eee;
  padding: 10px;
  text-align: center;
  border-top: 1px solid #ccc;
  z-index: 1000;
">
  <nav>
    <button onclick="goToSearch()">üîç Pesquisar</button>
    <button onclick="goToAvulsas()">üìÇ Avulsas</button>
    <button onclick="goToTrilha()">üõ§Ô∏è Trilha</button>
  </nav>
</footer>

  <script>
    //=============================
    // Estado da Aplica√ß√£o
    //=============================
    let subtitles = [];
    let currentIndex = 0;
    let formedWords = [];
    
    //=============================
    // Estado de Timer
    //=============================
    let timerInterval = null;
    let liveTimerInterval = null;
    let startTime = 0;
    let totalElapsedTime = 0;
    
    //=============================================
    // Vari√°vel global para o estado atual da li√ß√£o
    //=============================================
    let currentLessonContext = null; // 'trilha' ou 'avulsas'
	let currentLessonName = ''; // Nome da li√ß√£o atual

    
    //=============================
    // Lessons
    //=============================
    const avulsasLessons = [
      {
        name: "I'm Gonna Be - 500 Miles.mp4",
        srtUrl: "https://f005.backblazeb2.com/file/Avulsas/Im_Gonna_Be_-_500_Miles.srt",
        videoUrl: "https://f005.backblazeb2.com/file/Avulsas/Im_Gonna_Be_-_500_Miles.mp4"
      }
    ];

    const trilhaLessons = [
      {
        name: "Chapter 1 - Welcome & Nationalities",
        srtUrl: "https://f005.backblazeb2.com/file/Trilha/Chapter-1.-Welcome-%26-Nationalities.srt",
        videoUrl: "https://f005.backblazeb2.com/file/Trilha/Chapter-1.-Welcome-%26-Nationalities.mp4"
      }
    ];
    
    //=============================
    // Breadcrumb
    //=============================    
    function updateBreadcrumb() {
      const breadcrumb = document.getElementById('breadcrumb');
      if (!breadcrumb) return;

      let trail = ['SpeedPhrase'];

      const trilhaVisible = isSectionVisible('trilha-section');
      const avulsasVisible = isSectionVisible('avulsas-section');
      const gameVisible = isSectionVisible('videoSection');

      if (trilhaVisible) {
        trail.push('Trilha');
      } else if (avulsasVisible) {
        trail.push('Avulsas');
      }

      if (gameVisible && currentLessonName) {
        if (currentLessonContext === 'trilha') {
          trail.push('Trilha');
        } else if (currentLessonContext === 'avulsas') {
          trail.push('Avulsas');
        }
        trail.push(currentLessonName);
      }

      breadcrumb.textContent = trail.join(' ‚Ä∫ ');
    }

    function isSectionVisible(id) {
      const el = document.getElementById(id);
      return el && el.style.display !== 'none';
    }

    // Helper: verifica se elemento est√° vis√≠vel
    function isElementVisible(id) {
      const el = document.getElementById(id);
      return el && el.style.display !== 'none';
    }

    // Helper: verifica se se√ß√µes do game est√£o vis√≠veis
    function areGameSectionsVisible() {
      const ids = ['timerSection', 'videoSection', 'shuffledWordsSection'];
      return ids.every(id => isElementVisible(id));
    }

    // Helper: extrai nome da li√ß√£o do src do v√≠deo
    function getLessonNameFromSrc(src) {
      if (!src) return null;
      const parts = decodeURIComponent(src).split('/');
      const filename = parts[parts.length - 1];
      const name = filename.replace(/\.(mp4|webm)$/i, '').replace(/[_-]/g, ' ');
      return name;
    }

    //=============================
    // Fun√ß√£o: Carrega e Processa o SRT
    //=============================
    async function loadSrt(url) {
      const res = await fetch(url);
      const text = await res.text();
      return parseSRT(text);
    }

    //=============================
    // Fun√ß√£o: Parser SRT simples
    //=============================
    function parseSRT(srt) {
      const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n{2,}|$)/g;
      let result = [];
      let match;
      while ((match = regex.exec(srt)) !== null) {
        result.push({
          index: Number(match[1]),
          start: timeToSeconds(match[2]),
          end: timeToSeconds(match[3]),
          text: match[4].replace(/\n/g, ' ').trim()
        });
      }
      return result;
    }

    //=============================
    // Fun√ß√£o: Converte tempo SRT para segundos
    //=============================
    function timeToSeconds(time) {
      const [h, m, s] = time.replace(',', '.').split(':');
      return parseFloat(h) * 3600 + parseFloat(m) * 60 + parseFloat(s);
    }

    //=============================
    // Fun√ß√£o: Embaralha palavras
    //=============================
    function shuffleWords(text) {
      const words = text.split(' ');
      for (let i = words.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [words[i], words[j]] = [words[j], words[i]];
      }
      return words;
    }

    //=========================================
    // Aplica CSS e exibe palavras embaralhadas
    //=========================================
    function displayShuffledWords(words, original) {
      const container = document.getElementById('shuffledWords');
      container.innerHTML = '';
      formedWords = [];

      words.forEach(word => {
        const btn = document.createElement('button');
        btn.className = 'word';
        btn.textContent = word;
        btn.type = 'button'; // evita comportamento padr√£o de submit
        btn.onclick = () => handleWordClick(word, btn, original);
        container.appendChild(btn);
      });

      updateFormedSentence();
    }
    
    //=============================
    // Fun√ß√£o principal de clique
    //=============================
    function handleWordClick(word, element, original) {
      if (isCorrectWord(word, original)) {
        processCorrectWord(word, element);
        clearIncorrectWords();
      } else {
        markWordAsIncorrect(element);
      }

      updateFormedSentence();
      checkIfSentenceIsComplete(original);
    }

	//=============================
    // Verifica se palavra est√° correta
    //=============================
    function isCorrectWord(word, original) {
      const expectedWords = original.split(' ');
      const currentIndex = formedWords.length;
      return word === expectedWords[currentIndex];
    }

    //=============================
    // Processa palavra correta
    //=============================
    function processCorrectWord(word, element) {
      formedWords.push(word);
      element.classList.add('correct');
      element.onclick = null;
    }

    //=============================
    // Marca palavra incorreta (n√£o adiciona √† frase)
    //=============================
    function markWordAsIncorrect(element) {
      element.classList.add('incorrect');
    }

    //=============================
    // Limpa marca√ß√µes incorretas
    //=============================
    function clearIncorrectWords() {
      const incorrectElements = document.querySelectorAll('.word.incorrect');
      incorrectElements.forEach(el => {
        el.classList.remove('incorrect');
      });
    }

    //=============================
    // Verifica se frase est√° completa e correta
    //=============================
    function checkIfSentenceIsComplete(original) {
      if (formedWords.join(' ') === original) {
        setTimeout(() => {
          const timeUsed = stopTimerAndGetElapsed();
          console.log(`‚è±Ô∏è Tempo para essa frase: ${timeUsed}s`);
          displayTotalTime(); // atualiza tempo acumulado na tela

          if (currentIndex < subtitles.length - 1) {
            nextPhrase();
          } else {
            alert('üéâ Todas as frases completas! Li√ß√£o finalizada.');
          }
        }, 200);
      }
    }
    
    //=============================
    // Fun√ß√£o: Atualiza frase formada
    //=============================
    function updateFormedSentence() {
      document.getElementById('formedSentence').textContent = formedWords.join(' ');
    }

    //=============================
    // Fun√ß√£o: Avan√ßa para pr√≥xima frase
    //=============================
    function nextPhrase() {
      if (currentIndex < subtitles.length - 1) {
        currentIndex++;
        prepareCurrentSubtitle();
      } else {
        alert("‚úÖ Fim das legendas!");
      }
    }

    //=============================
    // Fun√ß√£o: Prepara legenda atual
    //=============================
    function prepareCurrentSubtitle() {
      const sub = subtitles[currentIndex];
      const shuffled = shuffleWords(sub.text);

      displayShuffledWords(shuffled, sub.text);

      const timeLimit = getTimeLimitForSentence(sub.text);
      startCountdown(timeLimit);
      startTimer(); // come√ßa a contar tempo real
      playCurrentSubtitle();
    }

    //==============================================================
    // Inicia o v√≠deo no tempo especificado e come√ßa a tocar
    //==============================================================
    function startVideoAtTime(video, startTime) {
      video.currentTime = startTime;
      video.play();
    }
    
    //=============================
    // Pausa v√≠deo
    //=============================
    function pauseVideo() {
      const video = document.getElementById('video');
      if (video) {
        video.pause();
        video.currentTime = 0; // opcional: reseta para o in√≠cio
      }
    }

    //=============================================================
    // Pausa v√≠edo no tempo final usando requestVideoFrameCallback
    //=============================================================
    function monitorVideoEnd(video, endTime) {
      function checkFrame() {
        if (video.currentTime >= endTime) {
          video.pause();
        } else {
          if (typeof video.requestVideoFrameCallback === 'function') {
            video.requestVideoFrameCallback(checkFrame);
          } else {
            setTimeout(checkFrame, 50);
          }
        }
      }
      checkFrame();
    }

    //=============================
    // Fun√ß√£o principal que usa as duas acima
    //=============================
    function playCurrentSubtitle() {
      const video = document.getElementById('video');
      const sub = subtitles[currentIndex];
      if (!video || !sub) return;

      startVideoAtTime(video, sub.start);
      monitorVideoEnd(video, sub.end);
    }
    
    //=============================
    // Bloco de Timer
    //=============================
    // Retorna tempo (segundos) para frase (palavras / 5)
    //=============================
    function getTimeLimitForSentence(sentence) {
      const wordCount = sentence.trim().split(/\s+/).length;
      return Math.ceil(wordCount * 3);
    }
    
    // Fun√ß√£o para formatar tempo em minutos e segundos
    function formatTime(seconds) {
      if (seconds < 60) {
        return seconds.toFixed(2) + 's';
      } else {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = (seconds % 60).toFixed(2);
        return `${minutes}m ${remainingSeconds}s`;
      }
    }

    // Atualiza contagem regressiva
    function startCountdown(seconds) {
      const display = document.getElementById('timer');
      let remaining = seconds;

      clearInterval(timerInterval);
      display.textContent = `‚è≥ ${remaining}s`;

      timerInterval = setInterval(() => {
        remaining--;
        display.textContent = `üí£ ${remaining}s`;
        if (remaining <= 0) {
          clearInterval(timerInterval);
          display.textContent = '‚è∞ Tempo estimado esgotado!';
        }
      }, 1000);
    }

    // Inicia temporizador do tempo ao vivo total
    function startLiveTotalTimeUpdate() {
      const liveDisplay = document.getElementById('liveTotalTime');

      if (liveTimerInterval) clearInterval(liveTimerInterval);

      liveTimerInterval = setInterval(() => {
        const now = performance.now();
        const currentElapsed = (now - startTime) / 1000;
        const liveTotal = totalElapsedTime + currentElapsed;

        liveDisplay.textContent = `‚è≥ Tempo total ao vivo: ${formatTime(liveTotal)}`;
      }, 200);
    }

    // Para temporizador ao vivo (ex: ao finalizar frase)
    function stopLiveTotalTimeUpdate() {
      if (liveTimerInterval) {
        clearInterval(liveTimerInterval);
        liveTimerInterval = null;
      }
    }

    // Exibe o tempo total fixo acumulado
    function displayTotalTime() {
      const totalTimeElement = document.getElementById('totalTime');
      totalTimeElement.textContent = `‚è±Ô∏è Tempo total: ${formatTime(totalElapsedTime)}`;
    }

    // Ao iniciar a frase
    function startTimer() {
      startTime = performance.now();
      startLiveTotalTimeUpdate();
    }

    // Ao finalizar frase
    function stopTimerAndGetElapsed() {
      const endTime = performance.now();
      const elapsed = (endTime - startTime) / 1000;
      totalElapsedTime += elapsed;
      stopLiveTotalTimeUpdate();
      displayTotalTime();
      return elapsed.toFixed(2);
    }
    
    //=============================
    // Bloco de Footer
    //=============================
    // ---------------
    //=============================
    function goToAvulsas() {
      hideGameSectionsById();
      hideLessonSections();
      showOnlySection('avulsas-section');
      generateVideoCards(avulsasLessons, 'avulsas-grid', handleLessonClick);
      updateBreadcrumb()
    }

    function goToTrilha() {
      hideGameSectionsById();
      hideLessonSections();
      showOnlySection('trilha-section');
      generateVideoCards(trilhaLessons, 'trilha-grid', handleLessonClick);
      updateBreadcrumb()
    }

    function showOnlySection(sectionId) {
      const el = document.getElementById(sectionId);
      if (el) el.style.display = '';
    }

	//=============================
    // Bloco Ocultar/Mostrar sections
    //=============================
    // Oculta game sections pelo ID
    //=============================
    function hideGameSectionsById() {
      const idsToHide = [
        'timerSection',
        'videoSection',
        'formedSentenceSection',
        'shuffledWordsSection'
      ];

      idsToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });

        pauseVideo();
    }
    
    //=============================
    // Mostra game sections pelo ID
    //=============================
    function showGameSectionsById() {
      const idsToShow = [
        'timerSection',
        'videoSection',
        'formedSentenceSection',
        'shuffledWordsSection'
      ];

      idsToShow.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = '';
      });
    }

    //=============================
    // Oculta as se√ß√µes de sele√ß√£o
    //=============================
    function hideAvulsasSections() {
      const idsToHide = [
        'avulsas-section'
      ];

      idsToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
    }
    
    function hideTrilhaSections() {
      const idsToHide = [
        'trilha-section'
      ];

      idsToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
    }
    
    function hideLessonSections() {
      hideAvulsasSections();
      hideTrilhaSections();
    }

    //=============================
    // Mostra as se√ß√µes de sele√ß√£o
    //=============================
    function showAvulsasSections() {
      const idsToShow = [
        'avulsas-section'
      ];

      idsToShow.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = '';
      });
    }
    
    function showTrilhaSections() {
      const idsToShow = [
        'trilha-section'
      ];

      idsToShow.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = '';
      });
    }
    
    function showLessonSections() {
      showAvulsasSections();
      showTrilhaSections();
    }    
    
    //=========================
    // Bloco lessons cards
    //=========================
    // Cria um card individual
    //=========================
    function createVideoCard(lesson, onClick) {
      const card = document.createElement('div');
      card.className = 'video-card';
      card.textContent = lesson.name;
      card.onclick = () => onClick(lesson);
      return card;
    }
    
    //==========================================
    // Gera grid de cards dentro do container
    //==========================================
    function generateVideoCards(lessons, containerId, onClick) {
      const container = document.getElementById(containerId);
      if (!container) return;

      container.innerHTML = ''; // limpa antes de inserir

      lessons.forEach(lesson => {
        const card = createVideoCard(lesson, onClick);
        container.appendChild(card);
      });
    }

    
    //==========================================
    // Carrega li√ß√µes nas se√ß√µes correspondentes
    //==========================================
    function loadAllLessons() {
      generateVideoCards(avulsasLessons, 'avulsas-grid', handleLessonClick);
      generateVideoCards(trilhaLessons, 'trilha-grid', handleLessonClick);
    }

    //=============================
    // Clique no card de li√ß√£o
    //=============================
    function handleLessonClick(lesson) {
      console.log('Li√ß√£o selecionada:', lesson);

      // Determina se a li√ß√£o √© da trilha ou avulsas com base nas listas
      if (trilhaLessons.includes(lesson)) {
        currentLessonContext = 'trilha';
      } else if (avulsasLessons.includes(lesson)) {
        currentLessonContext = 'avulsas';
      }

      currentLessonName = lesson.name;

      // Aqui voc√™ pode:
      // - ocultar se√ß√µes de sele√ß√£o
      // - mostrar o game
      // - carregar o v√≠deo e a legenda
      
      loadVideoAndSrt(lesson);
      hideLessonSections();
      showGameSectionsById();
      updateBreadcrumb()
    }
    
    //=============================
    // Clique no card de li√ß√£o
    //=============================
    async function loadVideoAndSrt(lesson) {
      const video = document.getElementById('video');
      video.src = lesson.videoUrl;
      subtitles = await loadSrt(lesson.srtUrl);
      currentIndex = 0;
      prepareCurrentSubtitle();
    }

    //=============================
    // Inicializa√ß√£o
    //=============================
    (async () => {
      subtitles = await loadSrt("https://f005.backblazeb2.com/file/Avulsas/Im_Gonna_Be_-_500_Miles.srt");
      prepareCurrentSubtitle();
    })();
    
    document.addEventListener('DOMContentLoaded', () => {
      updateBreadcrumb();
      hideGameSectionsById();
      loadAllLessons();
    });


  </script>

</body>
</html>
