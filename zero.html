<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpeedPhrase</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    .video-container, .words-container, .formed-sentence, .controls { margin-top: 20px; }
    .word { display: inline-block; margin: 5px; padding: 10px 15px; background: #eee; border-radius: 5px; cursor: pointer; }
    .word.correct { background-color: #c8f7c5; }
    .word.incorrect { background-color: #f7c5c5; }
    .formed-sentence { font-weight: bold; margin-top: 10px; }
    button { margin-top: 10px; padding: 10px 20px; }
    .video-grid-container {
      padding: 20px;
    }
    
    .hidden {
      display: none;
    }

    .video-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .video-card {
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 200px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .video-card:hover {
      transform: scale(1.03);
    }
  </style>
</head>
<body>

<main style="padding-bottom: 80px;">
  <!-- Header da pÃ¡gina com tÃ­tulo -->
  <header>
    <h1>SpeedPhrase</h1>
  </header>
  
  <section id="avulsas-section" class="video-grid-container">
    <div id="avulsas-grid" class="video-grid"></div>
  </section>

  <section id="trilha-section" class="video-grid-container">
    <div id="trilha-grid" class="video-grid"></div>
  </section>


  <!-- SeÃ§Ã£o do timer, separado do header -->
  <section id="timerSection" style="margin-top: 10px; font-weight: bold;">
    <div id="timer"></div>
    <div id="totalTime" style="margin-top: 5px;"></div>
  </section>

  <!-- SeÃ§Ã£o do vÃ­deo e controles -->
  <section id="videoSection" style="margin-top: 20px;">
    <div class="video-container">
      <video id="video" width="70%" height="340" controls>
        <source src="https://f005.backblazeb2.com/file/Avulsas/Im_Gonna_Be_-_500_Miles.mp4" type="video/mp4" />
      </video>
    </div>
    <div class="controls" style="margin-top: 10px;">
      <button onclick="playCurrentSubtitle()">â–¶ï¸ Tocar trecho</button>
    </div>
  </section>

  <!-- SeÃ§Ã£o da frase formada -->
  <section id="formedSentenceSection" style="margin-top: 20px;">
    <div class="formed-sentence" id="formedSentence"></div>
  </section>

  <!-- SeÃ§Ã£o das palavras embaralhadas -->
  <section id="shuffledWordsSection" style="margin-top: 20px;">
    <div class="words-container" id="shuffledWords"></div>
  </section>
</main>

<footer style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #eee;
  padding: 10px;
  text-align: center;
  border-top: 1px solid #ccc;
  z-index: 1000;
">
  <nav>
    <button onclick="goToSearch()">ğŸ” Pesquisar</button>
    <button onclick="goToAvulsas()">ğŸ“‚ Avulsas</button>
    <button onclick="goToTrilha()">ğŸ›¤ï¸ Trilha</button>
  </nav>
</footer>



  <script>
    //=============================
    // Estado da AplicaÃ§Ã£o
    //=============================
    let subtitles = [];
    let currentIndex = 0;
    let formedWords = [];
    Â 
    //=============================
    // Estado de Timer
    //=============================
    let startTime = 0;
    let totalElapsedTime = 0;
    let totalEstimatedTime = 0; // New variable
    let timerInterval = null;
    Â 
    //=============================
    // Lessons
    //=============================
	const avulsasLessons = [
    Â  {
    Â  Â  name: "I'm Gonna Be - 500 Miles.mp4",
    Â  Â  srtUrl: "https://files.catbox.moe/wt145j.srt",
    Â  Â  videoUrl: "https://files.catbox.moe/8pzqza.mp4"
    Â  }
    ];

    const trilhaLessons = [
    Â  {
    Â  Â  name: "Chapter 1 - Welcome & Nationalities",
    Â  Â  srtUrl: "https://files.catbox.moe/wt145j.srt",
    Â  Â  videoUrl: "https://files.catbox.moe/8pzqza.mp4"
    Â  }
    ];

    //=============================
    // FunÃ§Ã£o: Carrega e Processa o SRT
    //=============================
    async function loadSrt(url) {
    Â  const res = await fetch(url);
    Â  const text = await res.text();
    Â  return parseSRT(text);
    }

    //=============================
    // FunÃ§Ã£o: Parser SRT simples
    //=============================
    function parseSRT(srt) {
    Â  const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n{2,}|$)/g;
    Â  let result = [];
    Â  let match;
    Â  while ((match = regex.exec(srt)) !== null) {
    Â  Â  result.push({
    Â  Â  Â  index: Number(match[1]),
    Â  Â  Â  start: timeToSeconds(match[2]),
    Â  Â  Â  end: timeToSeconds(match[3]),
    Â  Â  Â  text: match[4].replace(/\n/g, ' ').trim()
    Â  Â  });
    Â  }
    Â  return result;
    }

    //=============================
    // FunÃ§Ã£o: Converte tempo SRT para segundos
    //=============================
    function timeToSeconds(time) {
    Â  const [h, m, s] = time.replace(',', '.').split(':');
    Â  return parseFloat(h) * 3600 + parseFloat(m) * 60 + parseFloat(s);
    }

    //=============================
    // FunÃ§Ã£o: Embaralha palavras
    //=============================
    function shuffleWords(text) {
    Â  const words = text.split(' ');
    Â  for (let i = words.length - 1; i > 0; i--) {
    Â  Â  const j = Math.floor(Math.random() * (i + 1));
    Â  Â  [words[i], words[j]] = [words[j], words[i]];
    Â  }
    Â  return words;
    }

    //=============================
    // FunÃ§Ã£o: Exibe palavras embaralhadas
    //=============================
    function displayShuffledWords(words, original) {
    Â  const container = document.getElementById('shuffledWords');
    Â  container.innerHTML = '';
    Â  formedWords = [];

    Â  words.forEach(word => {
    Â  Â  const span = document.createElement('span');
    Â  Â  span.className = 'word';
    Â  Â  span.textContent = word;
    Â  Â  span.onclick = () => handleWordClick(word, span, original);
    Â  Â  container.appendChild(span);
    Â  });

    Â  updateFormedSentence();
    }
    Â 
    //=============================
    // FunÃ§Ã£o principal de clique
    //=============================
    function handleWordClick(word, element, original) {
    Â  if (isCorrectWord(word, original)) {
    Â  Â  processCorrectWord(word, element);
    Â  Â  clearIncorrectWords();
    Â  } else {
    Â  Â  markWordAsIncorrect(element);
    Â  }

    Â  updateFormedSentence();
    Â  checkIfSentenceIsComplete(original);
    }

	//=============================
    // Verifica se palavra estÃ¡ correta
    //=============================
    function isCorrectWord(word, original) {
    Â  const expectedWords = original.split(' ');
    Â  const currentIndex = formedWords.length;
    Â  return word === expectedWords[currentIndex];
    }

    //=============================
    // Processa palavra correta
    //=============================
    function processCorrectWord(word, element) {
    Â  formedWords.push(word);
    Â  element.classList.add('correct');
    Â  element.onclick = null;
    }

    //=============================
    // Marca palavra incorreta (nÃ£o adiciona Ã  frase)
    //=============================
    function markWordAsIncorrect(element) {
    Â  element.classList.add('incorrect');
    }

    //=============================
    // Limpa marcaÃ§Ãµes incorretas
    //=============================
    function clearIncorrectWords() {
    Â  const incorrectElements = document.querySelectorAll('.word.incorrect');
    Â  incorrectElements.forEach(el => {
    Â  Â  el.classList.remove('incorrect');
    Â  });
    }

    //=============================
    // Verifica se frase estÃ¡ completa e correta
    //=============================
    function checkIfSentenceIsComplete(original) {
    Â  if (formedWords.join(' ') === original) {
    Â  Â  setTimeout(() => {
    Â  Â  Â  const timeUsed = stopTimerAndGetElapsed();
    Â  Â  Â  console.log(`â±ï¸ Tempo para essa frase: ${timeUsed.toFixed(2)}s`);
    Â  Â  Â  updatePerformanceDisplay(timeUsed); 

    Â  Â  Â  if (currentIndex < subtitles.length - 1) {
    Â  Â  Â  Â  nextPhrase();
    Â  Â  Â  } else {
    Â  Â  Â  Â  alert('ğŸ‰ Todas as frases completas! LiÃ§Ã£o finalizada.');
    Â  Â  Â  Â  displayTotalTime();
    Â  Â  Â  }
    Â  Â  }, 200);
    Â  }
    }
    Â 
    //=============================
    // FunÃ§Ã£o: Atualiza frase formada
    //=============================
    function updateFormedSentence() {
    Â  document.getElementById('formedSentence').textContent = formedWords.join(' ');
    }

    //=============================
    // FunÃ§Ã£o: AvanÃ§a para prÃ³xima frase
    //=============================
    function nextPhrase() {
    Â  if (currentIndex < subtitles.length - 1) {
    Â  Â  currentIndex++;
    Â  Â  prepareCurrentSubtitle();
    Â  } else {
    Â  Â  alert("âœ… Fim das legendas!");
    Â  }
    }

    //=============================
    // FunÃ§Ã£o: Prepara legenda atual
    //=============================
    function prepareCurrentSubtitle() {
    Â  const sub = subtitles[currentIndex];
    Â  const shuffled = shuffleWords(sub.text);

    Â  displayShuffledWords(shuffled, sub.text);

    Â  startTimer();
    Â  playCurrentSubtitle();
    }


    //=============================
    // FunÃ§Ã£o: Inicia o vÃ­deo no tempo especificado e comeÃ§a a tocar
    //=============================
    function startVideoAtTime(video, startTime) {
    Â  video.currentTime = startTime;
    Â  video.play();
    }

    //=============================
    // FunÃ§Ã£o: Monitora o vÃ­deo para pausar no tempo final usando requestVideoFrameCallback
    //=============================
    function monitorVideoEnd(video, endTime) {
    Â  function checkFrame() {
    Â  Â  if (video.currentTime >= endTime) {
    Â  Â  Â  video.pause();
    Â  Â  } else {
    Â  Â  Â  if (typeof video.requestVideoFrameCallback === 'function') {
    Â  Â  Â  Â  video.requestVideoFrameCallback(checkFrame);
    Â  Â  Â  } else {
    Â  Â  Â  Â  setTimeout(checkFrame, 50);
    Â  Â  Â  }
    Â  Â  }
    Â  }
    Â  checkFrame();
    }

    //=============================
    // FunÃ§Ã£o principal que usa as duas acima
    //=============================
    function playCurrentSubtitle() {
    Â  const video = document.getElementById('video');
    Â  const sub = subtitles[currentIndex];
    Â  if (!video || !sub) return;

    Â  startVideoAtTime(video, sub.start);
    Â  monitorVideoEnd(video, sub.end);
    }
    Â 
    //=============================
    // Bloco de Timer (Revisado)
    //=============================
    // Retorna tempo (segundos) para frase (palavras / 5)
    //=============================
    function getTimeLimitForSentence(sentence) {
        // Conta todos os caracteres, excluindo espaÃ§os
        const characterCount = sentence.trim().replace(/\s/g, '').length;
        // Define o tempo estimado em segundos (ex: 0.2 segundos por caractere)
        const timePerCharacter = 0.2; 
        return characterCount * timePerCharacter;
    }

    // This function now calculates and displays the current performance.
    function updatePerformanceDisplay(elapsed) {
    Â  const display = document.getElementById('timer');
    Â  const sentenceEstimatedTime = getTimeLimitForSentence(subtitles[currentIndex].text);
    Â  let performance = (sentenceEstimatedTime / elapsed) * 100;

    Â  let emoji = 'ğŸ‘';
    Â  if (performance < 75) {
    Â  Â  emoji = 'ğŸ¢';
    Â  } else if (performance < 100) {
    Â  Â  emoji = 'ğŸ¤”';
    Â  } else if (performance > 125) {
    Â  Â  emoji = 'ğŸš€';
    Â  }

    Â  display.innerHTML = `Desempenho: <span style="font-weight: bold; color: ${performance >= 100 ? 'green' : 'red'};">${performance.toFixed(2)}%</span> ${emoji}`;
    }

    //=============================
    // Inicia contagem de tempo real do usuÃ¡rio
    //=============================
    function startTimer() {
    Â  startTime = performance.now(); // mais preciso que Date.now()
    }

    //=============================
    // Calcula tempo gasto em segundos
    //=============================
    function stopTimerAndGetElapsed() {
    Â  const endTime = performance.now();
    Â  const elapsed = (endTime - startTime) / 1000; // em segundos
    Â  totalElapsedTime += elapsed;
    Â  return elapsed;
    }

    //=============================
    // Exibe o tempo total acumulado
    //=============================
    function displayTotalTime() {
    Â  const totalTimeElement = document.getElementById('totalTime');
    Â  const totalPerformance = (totalEstimatedTime / totalElapsedTime) * 100;
    Â  totalTimeElement.innerHTML = `â±ï¸ Tempo total: ${totalElapsedTime.toFixed(2)}s | Desempenho geral: <span style="font-weight: bold; color: ${totalPerformance >= 100 ? 'green' : 'red'};">${totalPerformance.toFixed(2)}%</span>`;
    }
    Â 
    //=============================
    // Bloco de Footer
    //=============================
    // ---------------
    //=============================
    function goToAvulsas() {
    Â  hideAllSections();
    Â  document.getElementById('avulsas-section').style.display = '';
    Â  // Se a grade de avulsas precisa ser gerada novamente, chame a funÃ§Ã£o
    Â  generateVideoCards(avulsasLessons, 'avulsas-grid', handleLessonClick);
    }

    function goToTrilha() {
    Â  hideAllSections();
    Â  document.getElementById('trilha-section').style.display = '';
    Â  // Se a grade de trilha precisa ser gerada novamente, chame a funÃ§Ã£o
    Â  generateVideoCards(trilhaLessons, 'trilha-grid', handleLessonClick);
    }

	//=============================
    // Bloco de Ocultar/Mostrar seÃ§Ãµes
    //=============================

    function hideAllSections() {
    Â  const sectionsToHide = [
    Â  Â  'avulsas-section',
    Â  Â  'trilha-section',
    Â  Â  'timerSection',
    Â  Â  'videoSection',
    Â  Â  'formedSentenceSection',
    Â  Â  'shuffledWordsSection'
    Â  ];

    Â  sectionsToHide.forEach(id => {
    Â  Â  const el = document.getElementById(id);
    Â  Â  if (el) el.style.display = 'none';
    Â  });
    }
    Â 
    //=========================
    // Bloco lessons cards
    //=========================
    // Cria um card individual
    //=========================
    function createVideoCard(lesson, onClick) {
    Â  const card = document.createElement('div');
    Â  card.className = 'video-card';
    Â  card.textContent = lesson.name;
    Â  card.onclick = () => onClick(lesson);
    Â  return card;
    }
    Â 
    //==========================================
    // Gera grid de cards dentro do container
    //==========================================
    function generateVideoCards(lessons, containerId, onClick) {
    Â  const container = document.getElementById(containerId);
    Â  if (!container) return;

    Â  container.innerHTML = ''; // limpa antes de inserir

    Â  lessons.forEach(lesson => {
    Â  Â  const card = createVideoCard(lesson, onClick);
    Â  Â  container.appendChild(card);
    Â  });
    }

    Â 
    //==========================================
    // Carrega liÃ§Ãµes nas seÃ§Ãµes correspondentes
    //==========================================
    function loadAllLessons() {
    Â  generateVideoCards(avulsasLessons, 'avulsas-grid', handleLessonClick);
    Â  generateVideoCards(trilhaLessons, 'trilha-grid', handleLessonClick);
    }

    //=============================
    // Clique no card de liÃ§Ã£o
    //=============================
    async function handleLessonClick(lesson) {
    Â  console.log('LiÃ§Ã£o selecionada:', lesson);
    Â  hideAllSections();
    Â  document.getElementById('videoSection').style.display = '';
    Â  document.getElementById('timerSection').style.display = '';
    Â  document.getElementById('formedSentenceSection').style.display = '';
    Â  document.getElementById('shuffledWordsSection').style.display = '';

    Â  const video = document.getElementById('video');
    Â  video.src = lesson.videoUrl;
    Â  subtitles = await loadSrt(lesson.srtUrl);

    Â  // Calculate total estimated time for the lesson
    Â  totalEstimatedTime = subtitles.reduce((sum, sub) => {
    Â  Â  return sum + getTimeLimitForSentence(sub.text);
    Â  }, 0);
      
      totalElapsedTime = 0; // Reset total elapsed time for the new lesson

    Â  console.log(`â±ï¸ Tempo total estimado para a liÃ§Ã£o: ${totalEstimatedTime.toFixed(2)}s`);

    Â  currentIndex = 0;
    Â  prepareCurrentSubtitle();
    }
    Â 
    //=============================
    // Clique no card de liÃ§Ã£o
    //=============================
    async function loadVideoAndSrt(lesson) {
    Â  const video = document.getElementById('video');
    Â  video.src = lesson.videoUrl;
    Â  subtitles = await loadSrt(lesson.srtUrl);
    Â  currentIndex = 0;
    Â  prepareCurrentSubtitle();
    }

    //=============================
    // InicializaÃ§Ã£o
    //=============================
    document.addEventListener('DOMContentLoaded', () => {
    Â  loadAllLessons();
    Â  goToAvulsas();
    });
  </script>

</body>
</html>
