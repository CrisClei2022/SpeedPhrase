<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Treino com Legendas</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    .video-container, .words-container, .formed-sentence, .controls { margin-top: 20px; }
    .word { display: inline-block; margin: 5px; padding: 10px 15px; background: #eee; border-radius: 5px; cursor: pointer; }
    .word.correct { background-color: #c8f7c5; }
    .word.incorrect { background-color: #f7c5c5; }
    .formed-sentence { font-weight: bold; margin-top: 10px; }
    button { margin-top: 10px; padding: 10px 20px; }
  </style>
</head>
<body>

  <h1>Exerc√≠cio com Legendas</h1>
  
  <div id="timer" style="margin-top: 10px; font-weight: bold;"></div>
  <div id="totalTime" style="margin-top: 5px; font-weight: bold;"></div>

  <div class="video-container">
    <video id="video" width="70%" height="340" controls>
      <source src="https://f005.backblazeb2.com/file/Avulsas/Im_Gonna_Be_-_500_Miles.mp4" type="video/mp4">
    </video>
  </div>

  <div class="controls">
    <button onclick="playCurrentSubtitle()">‚ñ∂Ô∏è Tocar trecho</button>
  </div>

  <div class="formed-sentence" id="formedSentence"></div>
  <div class="words-container" id="shuffledWords"></div>

  <script>
    //=============================
    // Estado da Aplica√ß√£o
    //=============================
    let subtitles = [];
    let currentIndex = 0;
    let formedWords = [];
    
    //=============================
    // Estado de Timer
    //=============================
    let startTime = 0;
    let totalElapsedTime = 0;
    let timerInterval = null;


    //=============================
    // Fun√ß√£o: Carrega e Processa o SRT
    //=============================
    async function loadSrt(url) {
      const res = await fetch(url);
      const text = await res.text();
      return parseSRT(text);
    }

    //=============================
    // Fun√ß√£o: Parser SRT simples
    //=============================
    function parseSRT(srt) {
      const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n{2,}|$)/g;
      let result = [];
      let match;
      while ((match = regex.exec(srt)) !== null) {
        result.push({
          index: Number(match[1]),
          start: timeToSeconds(match[2]),
          end: timeToSeconds(match[3]),
          text: match[4].replace(/\n/g, ' ').trim()
        });
      }
      return result;
    }

    //=============================
    // Fun√ß√£o: Converte tempo SRT para segundos
    //=============================
    function timeToSeconds(time) {
      const [h, m, s] = time.replace(',', '.').split(':');
      return parseFloat(h) * 3600 + parseFloat(m) * 60 + parseFloat(s);
    }

    //=============================
    // Fun√ß√£o: Embaralha palavras
    //=============================
    function shuffleWords(text) {
      const words = text.split(' ');
      for (let i = words.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [words[i], words[j]] = [words[j], words[i]];
      }
      return words;
    }

    //=============================
    // Fun√ß√£o: Exibe palavras embaralhadas
    //=============================
    function displayShuffledWords(words, original) {
      const container = document.getElementById('shuffledWords');
      container.innerHTML = '';
      formedWords = [];

      words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        span.onclick = () => handleWordClick(word, span, original);
        container.appendChild(span);
      });

      updateFormedSentence();
    }
    
    //=============================
    // Fun√ß√£o principal de clique
    //=============================
    function handleWordClick(word, element, original) {
      if (isCorrectWord(word, original)) {
        processCorrectWord(word, element);
        clearIncorrectWords();
      } else {
        markWordAsIncorrect(element);
      }

      updateFormedSentence();
      checkIfSentenceIsComplete(original);
    }

	//=============================
    // Verifica se palavra est√° correta
    //=============================
    function isCorrectWord(word, original) {
      const expectedWords = original.split(' ');
      const currentIndex = formedWords.length;
      return word === expectedWords[currentIndex];
    }

    //=============================
    // Processa palavra correta
    //=============================
    function processCorrectWord(word, element) {
      formedWords.push(word);
      element.classList.add('correct');
      element.onclick = null;
    }

    //=============================
    // Marca palavra incorreta (n√£o adiciona √† frase)
    //=============================
    function markWordAsIncorrect(element) {
      element.classList.add('incorrect');
    }

    //=============================
    // Limpa marca√ß√µes incorretas
    //=============================
    function clearIncorrectWords() {
      const incorrectElements = document.querySelectorAll('.word.incorrect');
      incorrectElements.forEach(el => {
        el.classList.remove('incorrect');
      });
    }

    //=============================
    // Verifica se frase est√° completa e correta
    //=============================
    function checkIfSentenceIsComplete(original) {
      if (formedWords.join(' ') === original) {
        setTimeout(() => {
          const timeUsed = stopTimerAndGetElapsed();
          console.log(`‚è±Ô∏è Tempo para essa frase: ${timeUsed}s`);
          displayTotalTime(); // atualiza tempo acumulado na tela

          if (currentIndex < subtitles.length - 1) {
            nextPhrase();
          } else {
            alert('üéâ Todas as frases completas! Li√ß√£o finalizada.');
          }
        }, 200);
      }
    }
    
    //=============================
    // Fun√ß√£o: Atualiza frase formada
    //=============================
    function updateFormedSentence() {
      document.getElementById('formedSentence').textContent = formedWords.join(' ');
    }

    //=============================
    // Fun√ß√£o: Avan√ßa para pr√≥xima frase
    //=============================
    function nextPhrase() {
      if (currentIndex < subtitles.length - 1) {
        currentIndex++;
        prepareCurrentSubtitle();
      } else {
        alert("‚úÖ Fim das legendas!");
      }
    }

    //=============================
    // Fun√ß√£o: Prepara legenda atual
    //=============================
    function prepareCurrentSubtitle() {
      const sub = subtitles[currentIndex];
      const shuffled = shuffleWords(sub.text);

      displayShuffledWords(shuffled, sub.text);

      const timeLimit = getTimeLimitForSentence(sub.text);
      startCountdown(timeLimit);
      startTimer(); // come√ßa a contar tempo real
    }


    //=============================
    // Fun√ß√£o: Toca v√≠deo no trecho da legenda
    //=============================
    function playCurrentSubtitle() {
      const video = document.getElementById('video');
      const sub = subtitles[currentIndex];
      video.currentTime = sub.start;
      video.play();

      const duration = sub.end - sub.start;
      setTimeout(() => video.pause(), duration * 1000);
    }
    
    //=============================
    // Bloco de Timer
    //=============================
    // Retorna tempo (segundos) para frase (palavras / 5)
    //=============================
    function getTimeLimitForSentence(sentence) {
      const wordCount = sentence.trim().split(/\s+/).length;
      return Math.ceil(wordCount * 3);
    }

    //=============================
    // Inicia cron√¥metro regressivo na tela
    //=============================
    function startCountdown(seconds) {
      const display = document.getElementById('timer');
      let remaining = seconds;

      clearInterval(timerInterval); // limpa cron√¥metros anteriores
      display.textContent = `‚è≥ ${remaining}s`;

      timerInterval = setInterval(() => {
        remaining--;
        display.textContent = `‚è≥ ${remaining}s`;
        if (remaining <= 0) {
          clearInterval(timerInterval);
          display.textContent = '‚è∞ Tempo estimado esgotado!';
        }
      }, 1000);
    }

    //=============================
    // Inicia contagem de tempo real do usu√°rio
    //=============================
    function startTimer() {
      startTime = performance.now(); // mais preciso que Date.now()
    }

    //=============================
    // Calcula tempo gasto em segundos
    //=============================
    function stopTimerAndGetElapsed() {
      const endTime = performance.now();
      const elapsed = (endTime - startTime) / 1000; // em segundos
      totalElapsedTime += elapsed;
      return elapsed.toFixed(2);
    }

    //=============================
    // Exibe o tempo total acumulado
    //=============================
    function displayTotalTime() {
      const totalTimeElement = document.getElementById('totalTime');
      totalTimeElement.textContent = `‚è±Ô∏è Tempo total: ${totalElapsedTime.toFixed(2)}s`;
    }


    //=============================
    // Inicializa√ß√£o
    //=============================
    (async () => {
      subtitles = await loadSrt("https://f005.backblazeb2.com/file/Avulsas/Im_Gonna_Be_-_500_Miles.srt");
      prepareCurrentSubtitle();
    })();

  </script>

</body>
</html>
