<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhraseCraft</title>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto+Mono:wght@400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&display:wght@400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/appwrite@17.0.0"></script>

    <style>
        :root {
            /* Cores de Fundo e Sombra */
            --background-color: #f0f0f0;
            --shadow-color: rgba(0, 0, 0, 0.3);

            /* Novos Degrad√™s */
            --blue-gradient-start: #007bff; /* Azul vibrante */
            --blue-gradient-end: #0056b3;    /* Azul mais escuro */

            --grey-gradient-start: #d0d0d0; /* Agora o 'escuro' (que era o fim) */
            --grey-gradient-end: #e0e0e0;    /* Agora o 'claro' (que era o in√≠cio) */

            --red-gradient-start: #dc3545; /* Vermelho vibrante */
            --red-gradient-end: #a71d2a;    /* Vermelho mais escuro */

            --orange-gradient-start: #ffc107; /* Laranja vibrante */
            --orange-gradient-end: #e0a800;    /* Laranja mais escuro */

            /* Vari√°veis para o progresso do JavaScript (mantidas) */
            --progress: 0; /* 0 a 100 - Controla o preenchimento pelo JS */
        }

        body {
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: flex-start;
            background: linear-gradient(-135deg, #000000, #3b0047, #660000, #000000);
            margin: 0;
            padding-top: 1.2%;
            font-family: 'Orbitron', sans-serif;
            color: #00ccff;
            text-shadow:
                0 0 15px rgba(0, 204, 255, 0.3), /* Tom da cor base mais claro */
                0 0 25px rgba(0, 220, 255, 0.3), /* Um pouco mais claro e difuso */
                0 0 35px rgba(0, 235, 255, 0.1); /* Mais claro e ainda mais difuso */
            letter-spacing: 1.5px;
            overflow: hidden;
        }

        button {
            padding: 10px 15px;
            background: linear-gradient(to bottom, #5cbc5c 0%, #4CAF50 50%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }

        button:hover {
            background: linear-gradient(to bottom, #6ad26a 0%, #5cbc5c 50%, #4CAF50 100%);
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            transform: translateY(-1px);
        }

        button:active {
            background: linear-gradient(to bottom, #45a049 0%, #4CAF50 50%, #5cbc5c 100%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            transform: translateY(1px);
        }
	    
        #menu-button {
            margin-top: -5%;
            background: transparent;
            text-decoration: none;
            color: #14fff1;
            border: 0px solid #14fff1;
            border-radius: 6px; /* Keep your existing border-radius */
            box-shadow:
                0px 0px 16px rgba(0, 0, 0, 0.6), /* Existing outer shadow */
                /* Inner bottom glow - Adjust these values for the "egg tip" shape */
                inset 0px -5px 6px -5px rgba(0, 204, 255, 0.7), /* Base inner glow */
                inset 0px -7px 6px -8px rgba(0, 220, 255, 0.5), /* Lighter, more diffuse */
                inset 0px -10px 6px -10px rgba(0, 235, 255, 0.3); /* Lightest, most diffuse */
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out; /* Added box-shadow transition too */
            font-family: 'Audiowide', sans-serif; /* Apply the font */
            font-size: 0.65em;
            letter-spacing: 0.2em; /* Optional: adds a slight space between letters for a techy look */
            text-transform: uppercase; /* Optional: makes text uppercase, common in futuristic UIs */
        }

        #menu-button:hover {
            box-shadow:
                0px 0px 16px rgba(0, 0, 0, 0.6), /* Existing outer shadow */
                inset 0px -5px 6px -5px rgba(0, 204, 255, 0.7),
                inset 0px -7px 6px -8px rgba(0, 220, 255, 0.5),
                inset 0px -10px 6px -10px rgba(0, 235, 255, 0.3);
            transform: translateY(-1px); /* Lifts up slightly on hover */
        }

        #menu-button:active {
            box-shadow:
                0px 0px 8px rgba(0, 0, 0, 0.8), /* outer shadow darker/more intense when pressed */
                inset 0px 0px 3px rgba(0, 204, 255, 0.9), /* inner glow when pressed */
                inset 0px 0px 5px rgba(0, 220, 255, 0.7); /* inner glow for depth */
            transform: translateY(2px); /* Moves down when clicked */
            background-color: transparent; /* Keep background transparent */
        }

        #menu-overlay {
            position: fixed;
            top: 0; /* Changed from 1% for full top alignment */
            right: 0; /* Changed from 1% for full right alignment */
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            font-family: 'Audiowide', sans-serif;
            z-index: 999;
            display: flex; /* Enable Flexbox */
            flex-direction: column; /* Stack items vertically (close-button above menu-items) */
            align-items: center; /* This centers items horizontally in a column layout */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(8px);
        }

        #menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #menu-items {
            justify-content: center;
            width: 80%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 10px;
            background-color: #3b0047;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .menu-title {
            text-align: center;
            color: #f9fff2;
            font-size: 22px;
            margin-bottom: 18px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-family: 'Audiowide', sans-serif; /* Apply the font */
            letter-spacing: 0.05em; /* Optional: adds a slight space between letters for a techy look */
            text-transform: uppercase; /* Optional: makes text uppercase, common in futuristic UIs */
        }

        .lesson-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            text-align: left;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .lesson-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.2);
        }

        .lesson-button:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-100%);
            transition: all 0.6s ease;
        }

        .lesson-button:hover:after {
            transform: translateX(100%);
        }

		/* New CSS for the header row containing 'Ajuda' and the close button */
		.menu-header {
		    display: flex;
		    justify-content: space-between; /* ‚ú® REVERTIDO: Para empurrar Ajuda e Fechar para as extremidades */
		    align-items: center;
		    width: 100%;
		    padding: 10px 20px;
		    box-sizing: border-box;
		    /* Remover 'gap' aqui, j√° que space-between e margens auto v√£o gerenciar o espa√ßamento */
		}
        
		/* Ajustes para o bot√£o "Ajuda" */
		.close-button, #info {
		    background: grey;
            color: white;
		    border-radius: 8px;
		    padding: 10px;
		    flex-shrink: 0;
		    /* Remover margin-right: auto; daqui se estiver, n√£o √© necess√°rio com justify-content: space-between */
		}

        .close-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }

        .close-button:before {
            transform: rotate(45deg);
        }

        .close-button:after {
            transform: rotate(-45deg);
        }

        /* Loading Indicator */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }

        #loading.active {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Current lesson info */
        #current-lesson {
            text-align: center;
            color: #f9fff2;
            margin-top: 5px;
            font-size: 16px;
            font-weight: bold;
        }
		
        #subtitle-content {
            margin-top: 20px;
            padding: 25px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            min-height: 100px;
            text-align: left;
            font-size: 1.1em;
            color: #555;
            transition: opacity 0.5s ease-in-out; /* Transi√ß√£o para o efeito de "sumir" */
            line-height: 1.6;
        }

        #subtitle-content.hidden {
            opacity: 0; /* Torna o conte√∫do invis√≠vel */
            max-height: 0; /* Colapsa o espa√ßo ocupado */
            overflow: hidden;
            padding: 0 25px; /* Remove padding quando oculto */
            border: none; /* Remove a borda quando oculto */
        }

        /* ==========
        // Login
        // ========== */
        header {
        	width: 90%;
            backdrop-filter: blur(20px);
            background: rgba(10, 10, 10, 0.8);
            border-radius: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-title {
            font-weight: 700;
            font-size: 1.4em;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 2s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: drop-shadow(0 0 5px rgba(255, 107, 107, 0.3)); }
            to { filter: drop-shadow(0 0 20px rgba(69, 183, 209, 0.5)); }
        }
        
        .user-buttons {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .user-buttons div {
            font-size: 0.9em;
            font-weight: 500;
            color: #ffffff;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .user-buttons div:hover {
            color: #4ecdc4;
            transform: translateY(-2px);
            filter: brightness(1.2);
        }

        .user-buttons .btnSignup:hover {
            transform: translateY(-2px);
            filter: brightness(1.2);
        }

        /* --- Estilos da Tela de Login (CENTRALIZADA) --- */
        .login-screen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            opacity: 1;
            transition: opacity 0.5s ease;
            z-index: 2000;
        }

        .login-screen-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-card {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(1);
            animation: loginCardAppear 0.3s ease-out;
        }

        @keyframes loginCardAppear {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .close-button:hover {
            transform: rotate(90deg);
        }

        .login-card h2 {
            font-size: 2em;
            margin-bottom: 25px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-card input {
            width: 90%;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .login-card input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .login-card input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }

        .login-button {
            width: 50%;
            padding: 15px;
            background: linear-gradient(45deg, #4ecdc4, #45b7d1);
            border: none;
            border-radius: 8px;
            color: #0a0a0a;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(69, 183, 209, 0.4);
        }

        .login-card p {
            font-size: 0.9em;
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.7);
        }

        .login-card a {
            color: #4ecdc4;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .login-card a:hover {
            color: #ff6b6b;
            text-decoration: underline;
        }

        /* ==========
        // Containers
        // ========== */
        .main-container {
            background-image: linear-gradient(-135deg, #171627, #111d4a, #171627, #111d4a);
            background-color: #171627;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            text-align: center;
            width: 90%;
            max-width: 600px;
            padding: 10px;
            display: flex; /* Make main-container a flex container */
            flex-direction: column; /* Stack children vertically */
            gap: 5px; /* MUDAN√áA: Reduzido de 10px para 5px */
            justify-content: flex-start;
            align-items: center;
            animation: fadeInScale 1s ease-out;
        }

        .title-container {
            text-align: center;
        }

        .content-row {
            display: flex;
            flex-direction: row;
            margin-top: 1%;
            gap: 10px;
            align-items: center; /* ‚Üê MUDAN√áA: centraliza verticalmente */
            justify-content: center; /* ‚Üê ADICIONE: centraliza horizontalmente */
            width: 96%;
            flex-wrap: nowrap;
            overflow: hidden;
            min-height: 180px; /* ‚Üê ADICIONE: altura m√≠nima para melhor centraliza√ß√£o */
        }
        
        /* Ajustes para o container do v√≠deo */
        .content-row .video-container {
            flex: 1 1 70%;
            min-width: 0;
            max-width: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; /* ADICIONE ISSO: Torna este o cont√™iner de posicionamento para o filho absoluto */
        }

        /* O container do v√≠deo onde o player e a legenda ficam */
        .video-container #custom-video {
            /* Mantenha suas propriedades de tamanho para o v√≠deo em si */
            width: 100%; /* MUDAN√áA: Use 100% para preencher o pai */
            height: auto; /* MUDAN√áA: Use auto para manter o aspect ratio original do v√≠deo */
            aspect-ratio: 16/9; /* Mantenha isso para garantir a propor√ß√£o do v√≠deo */
            display: block; /* Garante que n√£o haja espa√ßo extra abaixo do v√≠deo */
            background-color: #000;
            border: none;
        }

		/* Estilos para o conte√∫do da legenda que aparecer√° sobre o v√≠deo */
		#subtitle-content {
            position: absolute;
            width: 95%;
            height: auto;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 1.0em;
            box-sizing: border-box;
            z-index: 10;
            top: 50%; /* Moves the top edge of the element to the middle of its parent */
            transform: translateY(-50%); /* Shifts the element up by half of its own height */
        }
		
		/* Classe para ocultar o conte√∫do da legenda */
		#subtitle-content.hidden {
		    display: none;
		}
        
        /* Ajustes para os bot√µes */
        .content-row #buttons {
            flex: 1 1 40%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center; /* ‚Üê MUDAN√áA: centraliza bot√µes horizontalmente */
            justify-content: center; /* ‚Üê ADICIONE: centraliza bot√µes verticalmente */
            min-width: 0;
            max-width: 40%;
            padding: 0; /* ‚Üê MUDAN√áA: remove padding-top */
        }
        
        /* Opcional: Para garantir que os bot√µes tenham largura consistente */
        .content-row #buttons button {
            width: 100%;
            max-width: 200px; /* ‚Üê ADICIONE: largura m√°xima para os bot√µes */
            padding: 10px;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        p {
            margin: 10px 0;
            color: #666;
        }
        
        .phrase-container {
            font-size: 24px;
            width: 95%;
            min-height: 60px;
            border: 1px dashed #a5b68f;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            word-break: break-word;
            background-color: #f9fff2;
            color: #333;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .palavra-na-frase { /* Added style for words in the displayed phrase */
            margin-right: 1.2%;
            color: #0056b3; /* A distinct color for correctly placed words */
            border: 1px solid #ccc; 
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .word-button-wrapper {
            width: 100%; /* Ensures the wrapper takes full available width */
            display: flex; /* Keeping it flex allows for easy centering of its children */
            flex-direction: column; /* Stack children vertically */
            align-items: center; /* Center children horizontally */
            gap: 10px; /* Adjust gap as needed for spacing between word container and button */
        }

        .word-container {
            flex-wrap: wrap;
            width: 95%;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 10px;
        }

        .palavra { 
            background-color: #007bff;
            color: white;
            padding: 2px 5px; /* Change this line */
            margin: 5px; /* Added margin for spacing between words */
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
            user-select: none; /* Impede sele√ß√£o de texto */
        }

        .palavra.selecionada {
            background: linear-gradient(to bottom, #ffc107, #e0a800); /* Um gradiente laranja para destaque */
            transform: translateY(-2px); /* Efeito de eleva√ß√£o */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); /* Sombra mais forte */
        }

        .palavra.errada { /* Corrected class name */
            animation: shake 0.4s ease-in-out;
            background-color: #dc3545; /* Vermelho */
        }

        .palavra.acertada {
            background-color: #28a745; /* Green for correct words */
            pointer-events: none; /* Disable clicks on already correct words */
        }

	.palavra.no-click {
	    pointer-events: none; /* Impede que o mouse interaja com o elemento */
	    opacity: 0.6;        /* Torna um pouco transparente para indicar desativa√ß√£o */
	    cursor: default;     /* Muda o cursor para indicar que n√£o √© clic√°vel */
	}

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .players-container {
            position: relative;
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%; /* ‚Üê MUDAN√áA: garante que n√£o exceda o container pai */
            max-width: 100%; /* ‚Üê ADICIONE: for√ßa limita√ß√£o */
            margin: 0 auto;      /* Center it horizontally */
        }

        .player-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        .player-container,
        .title-container {
            flex: 1; /* Ocupa partes iguais */
            display: flex;
            flex-direction: column;
            align-items: center; /* ‚Üê Centraliza horizontalmente */
        }

        .player-content {
            position: relative;
            width: 70px;
            height: 70px;
            background: linear-gradient(-135deg, #000000, #3b0047, #660000, #000000);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(calc((85px - 70px) / 2));
        }

        .player-content h6 {
            margin: 0; /* Remove default margins from h6 and p for tighter control */
            margin-bottom: 0.4em;
            padding-top: 0.4em;
            line-height: 1.6em; /* Adjust line height if needed */
            font-size: 0.7em; /* Adjust font size if too large */
        }

        .clock-face {
            position: absolute;
            width: 85px;
            height: 85px;
            background: linear-gradient(135deg, var(--blue-gradient-start), var(--blue-gradient-end));
            border-radius: 15px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            align-items: flex-start;
            transition: background 0.7s ease-in-out;
        }

        /* Onde a magia do preenchimento circular acontece (sempre cinza) */
        .clock-face::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 8px;
            /* A cor de preenchimento SEMPRE ser√° cinza */
            background: conic-gradient(
                var(--grey-gradient-start) calc(var(--progress) * 1%),
                var(--grey-gradient-end) calc(var(--progress) * 1% + 1%),
                transparent calc(var(--progress) * 1% + 1%)
            );
            transform: rotate(-0deg);
            transform-origin: center;
            transition: background 0.1s linear; /* Transi√ß√£o suave para o preenchimento */
        }

        /* Estilo para quando o tempo estiver nos 30% finais (ativado pelo JavaScript) */
        .clock-face.time-almost-up {
            /* O fundo do clock-face agora piscar√° com esta anima√ß√£o */
            animation: blink-red-to-orange 1s infinite alternate;
        }

        /* Anima√ß√£o para o piscar de vermelho degrad√™ para laranja degrad√™ NO FUNDO DO CLOCK-FACE */
        @keyframes blink-red-to-orange {
            0%, 100% {
                background: linear-gradient(135deg, var(--red-gradient-start), var(--red-gradient-end));
            }
            50% {
                background: linear-gradient(135deg, var(--orange-gradient-start), var(--orange-gradient-end));
            }
        }
        
       /* Estilos para a notifica√ß√£o de alerta */
		#custom-alert {
		    position: fixed;
		    bottom: 20px; /* Posi√ß√£o na parte inferior da tela */
		    left: 50%;
		    transform: translateX(-50%);
		    z-index: 3000; /* Um z-index alto para sobrepor tudo */
		    background-color: #333;
		    color: white;
		    padding: 15px 25px;
		    border-radius: 10px;
		    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
		    display: flex;
		    align-items: center;
		    gap: 15px; /* Espa√ßo entre a mensagem e o bot√£o */
		    transition: opacity 0.3s ease-in-out;
		}
		
		#custom-alert.hidden {
		    opacity: 0;
		    pointer-events: none; /* Desativa a intera√ß√£o quando est√° escondido */
		}
		
		/* Estilos para o bot√£o 'X' do alerta */
		#close-alert-btn {
		    background: transparent;
		    border: none;
		    color: #ff6b6b; /* Uma cor diferente para o bot√£o de fechar */
		    font-size: 1.2em;
		    cursor: pointer;
		    transition: transform 0.3s ease;
		}
		
		#close-alert-btn:hover {
		    transform: rotate(90deg);
		}
    </style>
</head>
<body>
    <div class="main-container">
      <header>
          <div class="header-content">
              <div class="header-title">üéÆ SpeedPhrase</div>
              <div class="user-buttons">
                  <div id="btnLogin" class="btnLogin">Entrar</div>
                  <div id="btnSignup" class="btnSignup">Cadastrar</div>
              </div>
          </div>
      </header>
    
      <section id="login-screen" class="login-screen-container hidden">
          <div class="login-card">
              <button class="close-button"  id="btnCloseLogin">‚úï</button>
              <h2>Entrar</h2>
              <input type="email" id="login-email" placeholder="E-mail">
              <input type="password" id="login-password" placeholder="Senha">
              <button class="login-button" onclick="login()">Entrar</button>
              <p>Esqueceu a senha? <a href="#">Recuperar</a></p>
              <hr style="border: none; border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 20px 0;">
              <p>N√£o tem uma conta? <a href="#" id="link-to-signup">Cadastre-se</a></p>
          </div>
      </section>

      <section id="signup-screen" class="login-screen-container hidden">
          <div class="login-card">
              <button class="close-button"  id="btnCloseSignup">‚úï</button>
              <h2>Cadastre-se</h2>
              <input type="email" id="signup-email" placeholder="E-mail">
              <input type="password" id="signup-password" placeholder="Senha">
              <button class="login-button" onclick="signup()">Cadastrar</button>
              <p>J√° tem uma conta? <a href="#" id="link-to-login">Entrar</a></p>
          </div>
      </section>

        <div id="menu-overlay">
        
            <div class="menu-header">
                <button id="info">Ajuda</button>
                
                <button class="close-button">‚õå</button>
            </div>
            
            <div id="menu-items">
                <h2 class="menu-title">Lista de Li√ß√µes</h2>
            </div>
            
        </div>

        <div id="loading">
            <div class="spinner"></div>
        </div>



        <div id="current-lesson"></div>

        <div class="content-row">
            <div class="video-container">
                <video id="custom-video" class="hide-controls" preload="auto" crossorigin="anonymous">
                </video>
        
                <div id="subtitle-content" class="hidden"> 
                	<!- As legendas aparecem aqui: -->
                </div>
                
            </div>

            <div id="buttons">
                <button id="repetir" style="background: linear-gradient(to bottom, #b34dd6 0%, #9C27B0 50%, #7c1f8e 100%);">Tocar Trecho</button>
                <button id="lerFrase" style="background: linear-gradient(to bottom, #78c0ff 0%, #5babf0 50%, #4d98e5 100%);">Tocar Lento</button>
                <button id="traduzir-btn" class="control-button" style="background: linear-gradient(to bottom, #ffc078 0%, #ffa94d 50%, #e59442 100%);">Traduzir</button>
				<button id="desistir" style="background: linear-gradient(to bottom, #66bb6a 0%, #43a047 50%, #2e7d32 100%);">Passar: palavra</button>

                <button id="desistir" style="background: linear-gradient(to bottom, #ff5e91 0%, #E91E63 50%, #c41858 100%);">Desistir: frase</button>
                
             </div>
            
        </div>

        <div class="phrase-container" id="frase">
        </div>

        <div class="word-button-wrapper">
        
            <div class="word-container" id="palavras"></div>
            
        </div>
        
        <div id="progresso" style="margin-top: 10px; font-size: 0.9em;">Progresso: 0 de 0</div>
	    
		<div id="custom-alert" class="hidden">
		  <span id="alert-message"></span>
		  <button id="close-alert-btn" class="close-btn">‚úï</button>
		</div>
    </div>

<script>
// Li√ß√µes dispon√≠veis (nome do arquivo SRT e URL do v√≠deo)
const lessons = [
    {
        name: "Lady Gaga - Schei√üe",
        srtFile: "Lady_Gaga-Schei√üe.srt",
        videoUrl: "https://files.catbox.moe/noor8m.mp4"
    },
    {
        name: "Melanie Martinez - The Contortionist",
        srtFile: "Melanie_Martinez-The_Contortionist.srt",
        videoUrl: "https://files.catbox.moe/vxoldg.mp4"
    },
    {
        name: "New West - Those Eyes",
        srtFile: "New_West-Those_Eyes.srt",
        videoUrl: "https://files.catbox.moe/k7xhth.mp4"
    }
    // Adicione mais li√ß√µes conforme necess√°rio
];

// Entrar e Cadastrar
// Appwrite Initialization
const { Client, Account, ID } = Appwrite;

// Substitua 'YOUR_APPWRITE_ENDPOINT' pelo seu endpoint do Appwrite.
// Exemplo: 'https://cloud.appwrite.io/v1' ou 'http://localhost/v1'
const client = new Client();

// Substitua 'YOUR_APPWRITE_PROJECT_ID' pelo ID do seu projeto.
client
    .setEndpoint('https://nyc.cloud.appwrite.io/v1')
    .setProject('689f3d3a00095fde3112');

const account = new Account(client);
const loginScreen = document.getElementById('login-screen');
const signupScreen = document.getElementById('signup-screen');
const loginEmailInput = document.getElementById('login-email');
const loginPasswordInput = document.getElementById('login-password');
const signupEmailInput = document.getElementById('signup-email');
const signupPasswordInput = document.getElementById('signup-password');
const linkToSignup = document.getElementById('link-to-signup');
const linkToLogin = document.getElementById('link-to-login');

// Listeners dos bot√µes de fechar (X)
const btnCloseLogin = document.getElementById('btnCloseLogin');
const btnCloseSignup = document.getElementById('btnCloseSignup');

// Event listeners para abrir as telas de autentica√ß√£o
document.querySelector('.btnLogin').addEventListener('click', () => showLoginScreen());
document.querySelector('.btnSignup').addEventListener('click', () => showSignupScreen());

// Event listeners para fechar as telas de autentica√ß√£o
btnCloseLogin.addEventListener('click', () => closeLoginScreen());
btnCloseSignup.addEventListener('click', () => closeSignupScreen());

// Event listeners para navega√ß√£o entre telas de login/cadastro
linkToSignup.addEventListener('click', (e) => {
    e.preventDefault();
    showSignupScreen();
});
linkToLogin.addEventListener('click', (e) => {
    e.preventDefault();
    showLoginScreen();
});

// Fun√ß√µes para mostrar/ocultar as telas de autentica√ß√£o
function showLoginScreen() {
    loginScreen.classList.remove('hidden');
    signupScreen.classList.add('hidden');
}

function closeLoginScreen() {
    loginScreen.classList.add('hidden');
}

function showSignupScreen() {
    loginScreen.classList.add('hidden');
    signupScreen.classList.remove('hidden');
}

function closeSignupScreen() {
    signupScreen.classList.add('hidden');
}

async function login() {
    const email = loginEmailInput.value;
    const password = loginPasswordInput.value;

    if (!email || !password) {
        showAlert('Por favor, preencha todos os campos.');
        return;
    }

    try {
        await account.createEmailSession(email, password);
        showAlert('Login bem-sucedido!');
        isLoggedIn = true; // Atualiza o estado de login
        closeLoginScreen();
    } catch (error) {
        showAlert('Erro ao fazer login: ' + error.message);
    }
}

async function signup() {
    const email = signupEmailInput.value;
    const password = signupPasswordInput.value;

    if (!email || !password) {
        showAlert('Por favor, preencha todos os campos.');
        return;
    }

    try {
        await account.create(Appwrite.ID.unique(), email, password);
        showAlert('Conta criada com sucesso! Fa√ßa login para continuar.');
        showLoginScreen();
    } catch (error) {
        showAlert('Erro ao cadastrar: ' + error.message);
    }
}

// A fun√ß√£o de alerta deve estar aqui, antes das fun√ß√µes que a chamam
function showAlert(message) {
    const customAlert = document.getElementById('custom-alert');
    const alertMessage = document.getElementById('alert-message');

    alertMessage.textContent = message;
    customAlert.classList.remove('hidden');
}

// O event listener do bot√£o de fechar
document.getElementById('close-alert-btn').addEventListener('click', () => {
    document.getElementById('custom-alert').classList.add('hidden');
});

// Vari√°veis globais
let videoElement = document.getElementById('custom-video');
let frases = [];
let indiceFrase = 0;
let fraseAtual = null;
let palavrasEmbaralhadas = [];
let palavrasClicadas = [];
let palavraElementos = {};
let progresso = 0;
let playerReady = false;
let monitorTempoId;
let fraseAcertada = false;
let audioPlaying = false;
let currentLessonName = "";
let player1Clock; // Global variable for player 1's clock
let player2Clock; // Global variable for player 2's clock
let mostrarTraducao = false;
let palavrasDisponiveisElementos = [];

// NOVAS VARI√ÅVEIS DE JOGO
let tempoTotalJogador1 = 0;
let tempoTotalJogador2 = 0;
let tempoInicioTurno;
let fraseJaJogada = false;
let jogadorDaVez = 1;

// Fun√ß√£o para gerar o URL do CDN do jsDelivr para os arquivos SRT
function getSrtCdnUrl(filename) {
    const baseUrl = "https://raw.githubusercontent.com/CrisClei2022/srt/main/";
    return baseUrl + encodeURIComponent(filename);
}

// Fun√ß√£o para processar o conte√∫do SRT
function processSrtContent(srt) {
    frases = srt.split('\n\n').map(bloco => {
        let linhas = bloco.split('\n');
        if (linhas.length < 3) return null;

        return {
            tempoInicio: converterTempo(linhas[1].split(' --> ')[0].trim()),
            tempoFim: converterTempo(linhas[1].split(' --> ')[1].trim()),
            texto: linhas.slice(2).join(' ').trim()
        };
    }).filter(frase => frase !== null && frase.texto !== '' && !frase.texto.includes('www.RentAnAdviser.com'));

    indiceFrase = 0;
    fraseAtual = frases[indiceFrase];
    palavrasEmbaralhadas = embaralharPalavras(fraseAtual.texto);
    palavrasClicadas = [];
    progresso = 0;
    fraseAcertada = false;

    criarPalavras();
    atualizarFrase();
    atualizarProgresso();
    atualizarPlacares();
}

// Fun√ß√£o para carregar o arquivo SRT de uma URL
async function loadSrtFromUrl(url) {
    let srtLoadedSuccessfully = false;
    try {
        showLoading(true);
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Failed to load SRT: ${response.status}`);
        }
        const srtContent = await response.text();
        processSrtContent(srtContent);
        srtLoadedSuccessfully = true;
        if (!playerReady) {
            console.warn("V√≠deo n√£o est√° pronto. O jogo continuar√° usando apenas as legendas.");
            criarPalavras();
            atualizarFrase();
            atualizarProgresso();
        	atualizarPlacares();
            pararMonitorTempo();
        }
    } catch (error) {
        console.error("Erro ao carregar o arquivo SRT:", error);
       showAlert("Erro ao carregar o arquivo de legendas. O jogo continuar√° sem sincroniza√ß√£o de v√≠deo. Por favor, tente novamente mais tarde.");
        frases = [{
            tempoInicio: 0,
            tempoFim: 5,
            texto: "Aprenda a formar frases com pr√°tica di√°ria"
        }];
        indiceFrase = 0;
        fraseAtual = frases[indiceFrase];
        palavrasEmbaralhadas = embaralharPalavras(fraseAtual.texto);
        palavrasClicadas = [];
        progresso = 0;
        fraseAcertada = false;
        criarPalavras();
        atualizarFrase();
        atualizarProgresso();
        atualizarPlacares();
        document.getElementById('avancar').style.display = 'none';
        if (videoElement) {
            videoElement.pause();
            videoElement.src = '';
            videoElement.load();
            playerReady = false;
        }
        pararMonitorTempo();
    } finally {
        showLoading(false);
    }
    if (playerReady && fraseAtual && srtLoadedSuccessfully) {
        reproduzirTrechoAtual();
    }
    return srtLoadedSuccessfully;
}

// FUN√á√ÉO ATUALIZADA: Inicia um rel√≥gio aleat√≥rio no in√≠cio do jogo
function startRandomPlayerClock() {
    if (player1Clock) player1Clock.stop();
    if (player2Clock) player2Clock.stop();

    const randomPlayer = Math.random();
    if (randomPlayer < 0.5) {
        if (player1Clock) player1Clock.start();
        jogadorDaVez = 1;
        console.log("Player 1's clock started.");
    } else {
        if (player2Clock) player2Clock.start();
        jogadorDaVez = 2;
        console.log("Player 2's clock started.");
    }
    tempoInicioTurno = performance.now();
}

// Fun√ß√£o para carregar uma li√ß√£o
function loadLesson(lessonIndex) {
    const lesson = lessons[lessonIndex];
    currentLessonName = lesson.name;
    document.getElementById('current-lesson').textContent = currentLessonName;
    videoElement.src = lesson.videoUrl;
    videoElement.load();
    const srtUrl = getSrtCdnUrl(lesson.srtFile);
    loadSrtFromUrl(srtUrl).then(success => {
        if (success) {
            const progressoSalvo = carregarProgresso();
            if (progressoSalvo && progressoSalvo.lessonName === currentLessonName) {
                const retomar = confirm(`Deseja continuar da frase onde parou? | Frase ${progressoSalvo.fraseIndex + 1} | ${progressoSalvo.lessonName} |`);
                if (retomar && progressoSalvo.fraseIndex < frases.length) {
                    indiceFrase = progressoSalvo.fraseIndex;
                    tempoTotalJogador1 = progressoSalvo.tempoTotalJogador1;
                    tempoTotalJogador2 = progressoSalvo.tempoTotalJogador2;
                    fraseAtual = frases[indiceFrase];
                    palavrasEmbaralhadas = embaralharPalavras(fraseAtual.texto);
                    palavrasClicadas = [];
                    fraseAcertada = false;
                    progresso = indiceFrase;
                    criarPalavras();
                    atualizarFrase();
                    atualizarProgresso();
                    atualizarPlacares();
                }
            }
        }
    	startRandomPlayerClock();
    });
    toggleMenu();
    localStorage.setItem('lastLessonIndex', lessonIndex.toString());
}

// Fun√ß√£o para mostrar/esconder o indicador de carregamento
function showLoading(show) {
    const loadingElement = document.getElementById('loading');
    if (show) {
        loadingElement.classList.add('active');
    } else {
        loadingElement.classList.remove('active');
    }
}

// Fun√ß√£o para converter tempo de legenda para segundos
function converterTempo(tempo) {
    let partes = tempo.split(',');
    let segundos = partes[0].split(':');
    return parseInt(segundos[0]) * 3600 + parseInt(segundos[1]) * 60 + parseInt(segundos[2]) + parseInt(partes[1]) / 1000;
}

// Evento que ocorre quando o v√≠deo est√° pronto
videoElement.addEventListener('loadedmetadata', function() {
    playerReady = true;
    if (fraseAtual) {
        reproduzirTrechoAtual();
    }
});

// Fun√ß√£o para monitorar o tempo do v√≠deo
function iniciarMonitorTempo() {
    pararMonitorTempo();
    monitorTempoId = setInterval(() => {
        if (playerReady && fraseAtual) {
            let tempoAtual = videoElement.currentTime;
            if (tempoAtual >= fraseAtual.tempoFim) {
                videoElement.pause();
                pararMonitorTempo();
            }
        }
    }, 100);
}

// Fun√ß√£o para parar o monitor de tempo
function pararMonitorTempo() {
    if (monitorTempoId) {
        clearInterval(monitorTempoId);
        monitorTempoId = null;
    }
}

// Fun√ß√£o para embaralhar palavras
function embaralharPalavras(frase) {
    if (!frase) return [];
    let palavras = frase.split(' ');
    for (let i = palavras.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        let temp = palavras[i];
        palavras[i] = palavras[j];
        palavras[j] = temp;
    }
    return palavras;
}

// Fun√ß√£o para criar elementos de palavras
function criarPalavras() {
    let palavrasDiv = document.getElementById('palavras');
    palavrasDiv.innerHTML = '';
    palavrasDisponiveisElementos = [];
    palavraElementos = {};
    if (!palavrasEmbaralhadas || palavrasEmbaralhadas.length === 0) return;
    palavrasEmbaralhadas.forEach(palavra => {
        let palavraDiv = document.createElement('div');
        palavraDiv.classList.add('palavra');
        palavraDiv.innerText = palavra;
        palavraDiv.onclick = () => clicarPalavra(palavra, palavraDiv);
        if (!palavraElementos[palavra]) {
            palavraElementos[palavra] = [];
        }
        palavraElementos[palavra].push(palavraDiv);
        palavrasDiv.appendChild(palavraDiv);
        palavrasDisponiveisElementos.push(palavraDiv);
    });
}

// FUN√á√ÉO ATUALIZADA: L√≥gica para clicar na palavra
function clicarPalavra(palavra, elemento) {
    if (!fraseAtual || elemento.classList.contains('acertada')) {
        return;
    }

    if (speechSynthesis.speaking) speechSynthesis.cancel();
    if (playerReady && !videoElement.paused) videoElement.pause();
    
    const fraseSplit = fraseAtual.texto.split(' ');
    const proximaPalavraCorreta = fraseSplit[palavrasClicadas.length];
    const comprimentoFraseAtual = palavrasClicadas.length;
    
    const utterance = new SpeechSynthesisUtterance(palavra);
    utterance.lang = detectarIdioma(fraseAtual.texto);
    audioPlaying = true;
    
    if (palavra === proximaPalavraCorreta) {
        palavrasClicadas.push(palavra);
        elemento.classList.add('acertada');
        elemento.classList.remove('selecionada');
        atualizarFrase();

        if (comprimentoFraseAtual === fraseSplit.length - 2 && fraseSplit.length > 1) {
            const ultimaPalavra = fraseSplit[fraseSplit.length - 1];
            let elementoUltimaPalavraParaAutoEnviar = palavrasDisponiveisElementos.find(el => el.innerText === ultimaPalavra && !el.classList.contains('acertada') && !palavrasClicadas.includes(ultimaPalavra));
            if (elementoUltimaPalavraParaAutoEnviar) {
                palavrasClicadas.push(ultimaPalavra);
                elementoUltimaPalavraParaAutoEnviar.classList.add('acertada');
                elementoUltimaPalavraParaAutoEnviar.classList.remove('selecionada');
                atualizarFrase();
            }
        }
    } else {
        elemento.classList.add('errada');
        setTimeout(() => { elemento.classList.remove('errada'); }, 500);
    }
    
    if (palavrasClicadas.length === fraseSplit.length) {
        utterance.onend = function() {
            audioPlaying = false;
            finalizarTurnoComSucesso();
        };
    } else {
        utterance.onend = function() {
            audioPlaying = false;
        };
    }
    
    speechSynthesis.speak(utterance);
}

// FUN√á√ÉO ATUALIZADA: Finaliza o turno com sucesso (frase completa)
function finalizarTurnoComSucesso() {
    const tempoGasto = performance.now() - tempoInicioTurno;
    if (jogadorDaVez === 1) {
        tempoTotalJogador1 += tempoGasto;
    } else {
        tempoTotalJogador2 += tempoGasto;
    }

    if (player1Clock) player1Clock.stop();
    if (player2Clock) player2Clock.stop();

    if (!fraseJaJogada) {
        fraseJaJogada = true;
        jogadorDaVez = 2;
        resetarFraseParaNovoTurno();
        reproduzirTrechoAtual();

        // INICIA O CLOCK DO PR√ìXIMO JOGADOR IMEDIATAMENTE
        tempoInicioTurno = performance.now();
        player2Clock.start();

    } else {
        fraseJaJogada = false;
        jogadorDaVez = 1;
        processAndAdvancePhrase();
    }
}

// Fun√ß√£o corrigida para finalizar o turno com penalidade
function finalizarTurnoComPenalidade() {
    const penalidadeTempo = 10000;
    if (jogadorDaVez === 1) {
        tempoTotalJogador1 += penalidadeTempo;
    } else {
        tempoTotalJogador2 += penalidadeTempo;
    }
    
    if (!fraseJaJogada) {
        fraseJaJogada = true;
        jogadorDaVez = 2;
        resetarFraseParaNovoTurno();
        reproduzirTrechoAtual();

        // INICIA O CLOCK DO PR√ìXIMO JOGADOR IMEDIATAMENTE
        tempoInicioTurno = performance.now();
        player2Clock.start();
        
    } else {
        fraseJaJogada = false;
        jogadorDaVez = 1;
        processAndAdvancePhrase();
    }
}

// Essa fun√ß√£o j√° est√° correta, mas a inclui aqui para contextualizar
function resetarFraseParaNovoTurno() {
    palavrasClicadas = [];
    criarPalavras();
    atualizarFrase();
    atualizarPlacares();
}

// Fun√ß√£o para pausar todos os √°udios
function pausarAudios() {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        audioPlaying = false;
    }
    if (playerReady && !videoElement.paused) {
        videoElement.pause();
    }
}

// Fun√ß√£o para detectar o idioma com base no texto
function detectarIdioma(texto) {
    if (!texto) return 'en-US';
    if (texto.includes('Aku') || texto.includes('kamu')) {
        return 'id-ID';
    } else if (texto.includes('Schei√üe')) {
        return 'de-DE';
    }
    return 'en-US';
}

function translateSrt(text) {
    return new Promise((resolve, reject) => {
        if (text.trim() === '') {
            resolve('');
            return;
        }
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=pt&dt=t&q=${encodeURI(text)}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                let translation = '';
                data[0].forEach(item => {
                    translation += item[0];
                });
                resolve(translation);
            })
            .catch(error => {
                console.error('Erro na tradu√ß√£o:', error);
                reject(error);
            });
    });
}

// Fun√ß√£o para atualizar a frase exibida
function atualizarFrase() {
    let fraseDiv = document.getElementById('frase');
    let subtitleContentDiv = document.getElementById('subtitle-content');
    fraseDiv.innerHTML = '';
    palavrasClicadas.forEach((palavra) => {
        const span = document.createElement('span');
        span.textContent = palavra + ' ';
        span.classList.add('palavra-na-frase');
        fraseDiv.appendChild(span);
    });
    if (fraseAtual && subtitleContentDiv) {
        if (mostrarTraducao) {
            translateSrt(fraseAtual.texto)
                .then(translatedText => {
                    subtitleContentDiv.textContent = translatedText;
                    subtitleContentDiv.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Erro na tradu√ß√£o:', error);
                    subtitleContentDiv.textContent = fraseAtual.texto;
                    subtitleContentDiv.classList.remove('hidden');
                });
        } else {
            subtitleContentDiv.classList.add('hidden');
            subtitleContentDiv.textContent = '';
        }
    } else if (subtitleContentDiv) {
        subtitleContentDiv.classList.add('hidden');
        subtitleContentDiv.textContent = '';
    }
}

// Fun√ß√£o para ler a frase atual usando o sintetizador de voz
function lerFraseAtual() {
    if (!fraseAtual) return;
    pausarAudios();
    const utterance = new SpeechSynthesisUtterance(fraseAtual.texto);
    utterance.lang = detectarIdioma(fraseAtual.texto);
    audioPlaying = true;
    utterance.onend = function() {
        audioPlaying = false;
    };
    speechSynthesis.speak(utterance);
}

// Fun√ß√£o para atualizar o progresso
function atualizarProgresso() {
    document.getElementById('progresso').innerText = `Progresso: ${progresso} de ${frases.length}`;
}

// FUN√á√ÉO ATUALIZADA: Mostra o tempo acumulado
function atualizarPlacares() {
    const tempo1Segundos = Math.round(tempoTotalJogador1 / 1000);
    const tempo2Segundos = Math.round(tempoTotalJogador2 / 1000);
    document.getElementById('placar1').innerText = ` ${tempo1Segundos}s`;
    document.getElementById('placar2').innerText = ` ${tempo2Segundos}s`;
}

// Fun√ß√£o para reproduzir o trecho do v√≠deo atual
function reproduzirTrechoAtual() {
    if (!fraseAtual) return;
    pausarAudios();
    if (playerReady) {
        videoElement.currentTime = fraseAtual.tempoInicio;
        videoElement.play();
        iniciarMonitorTempo();
    } else {
        console.log("Player n√£o est√° pronto. Lendo a frase em vez de reproduzir o v√≠deo.");
        lerFraseAtual();
    }
}

// Fun√ß√£o para alternar a exibi√ß√£o do menu
function toggleMenu() {
    const menuButton = document.getElementById('menu-button');
    const menuOverlay = document.getElementById('menu-overlay');
    menuButton.classList.toggle('active');
    menuOverlay.classList.toggle('active');
}

// Inicializar bot√µes de menu
function initializeMenuButtons() {
    const menuItemsContainer = document.getElementById('menu-items');
    menuItemsContainer.innerHTML = '<h2 class="menu-title">Lista de Li√ß√µes</h2>';
    lessons.forEach((lesson, index) => {
        const button = document.createElement('button');
        button.textContent = lesson.name;
        button.classList.add('lesson-button');
        button.onclick = () => loadLesson(index);
        menuItemsContainer.appendChild(button);
    });
}

// --- Event Listeners ---

// FUN√á√ÉO ATUALIZADA: Bot√£o "Desistir"
document.getElementById('desistir').onclick = function() {
    if (!fraseAtual) return;
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    if (playerReady && !videoElement.paused) videoElement.pause();
    const fraseSplit = fraseAtual.texto.split(' ');
    const palavraCorretaAtual = fraseSplit[palavrasClicadas.length];
    if (!palavraCorretaAtual) {
        console.warn("Nenhuma palavra para revelar.");
        return;
    }
    let elementoCorretoParaAcertar = palavraElementos[palavraCorretaAtual].find(el => !el.classList.contains('acertada'));
    if (elementoCorretoParaAcertar) {
        palavrasClicadas.push(palavraCorretaAtual);
        elementoCorretoParaAcertar.classList.add('acertada');
        atualizarFrase();
        const utteranceRevelada = new SpeechSynthesisUtterance(palavraCorretaAtual);
        utteranceRevelada.lang = detectarIdioma(fraseAtual.texto);
        audioPlaying = true;
        const isFraseCompleta = palavrasClicadas.length === fraseSplit.length;
        if (isFraseCompleta) {
             utteranceRevelada.onend = function() {
                audioPlaying = false;
                finalizarTurnoComSucesso();
            };
        } else {
             utteranceRevelada.onend = function() {
                audioPlaying = false;
            };
        }
        speechSynthesis.speak(utteranceRevelada);
    }
};

document.getElementById('repetir').onclick = function() {
    reproduzirTrechoAtual();
};

document.getElementById('lerFrase').onclick = function() {
    lerFraseAtual();
};

document.getElementById('menu-button').onclick = toggleMenu;
document.querySelector('.close-button').onclick = toggleMenu;

document.getElementById('traduzir-btn').onclick = function() {
    mostrarTraducao = !mostrarTraducao;
    atualizarFrase();
};

videoElement.addEventListener('error', function(e) {
    console.error("Erro ao carregar o v√≠deo. O jogo continuar√° sem sincroniza√ß√£o com o v√≠deo.", e);
    playerReady = false;
    showAlert("Ocorreu um erro ao carregar o v√≠deo. O jogo continuar√° no modo texto.");
    pararMonitorTempo();
});

// FUN√á√ÉO ATUALIZADA: Cria√ß√£o do rel√≥gio
function createClock(clockFaceId) {
    const clockFace = document.getElementById(clockFaceId);
    let currentProgress = 0;
    const totalTimeMs = 10000;
    const updateIntervalMs = 16;
    const steps = totalTimeMs / updateIntervalMs;
    const progressPerStep = 100 / steps;
    let intervalId;
    let _isActive = false;

    function updateClock() {
        if (currentProgress <= 100) {
            clockFace.style.setProperty('--progress', currentProgress);
            const percentageRemaining = 100 - currentProgress;
            if (percentageRemaining <= 40 && percentageRemaining > 0) {
                clockFace.classList.add('time-almost-up');
            } else {
                clockFace.classList.remove('time-almost-up');
            }
            if (currentProgress >= 90 && _isActive) {
                document.querySelectorAll('.palavra').forEach(p => p.classList.add('no-click'));
            } else {
                document.querySelectorAll('.palavra').forEach(p => p.classList.remove('no-click'));
            }
            currentProgress += progressPerStep;
        } else {
            stopClock(true);
        }
    }

    function startClock() {
        currentProgress = 0;
        clockFace.classList.remove('time-almost-up');
        document.querySelectorAll('.palavra').forEach(p => p.classList.remove('no-click'));
        intervalId = setInterval(updateClock, updateIntervalMs);
        _isActive = true;
    }

    function stopClock(autoSwitch = false) {
        clearInterval(intervalId);
        clockFace.classList.remove('time-almost-up');
        _isActive = false;
        currentProgress = 0;
        clockFace.style.setProperty('--progress', currentProgress);
        if (autoSwitch) {
            finalizarTurnoComPenalidade();
        }
    }

    function isActive() {
        return _isActive;
    }

    return {
        start: startClock,
        stop: stopClock,
        isActive: isActive
    };
}

function getActiveClockId() {
    if (player1Clock && player1Clock.isActive()) {
        return 'clock-face1';
    }
    if (player2Clock && player2Clock.isActive()) {
        return 'clock-face2';
    }
    return null;
}

// Fun√ß√£o corrigida para avan√ßar a frase
function processAndAdvancePhrase() {
    if (player1Clock) player1Clock.stop();
    if (player2Clock) player2Clock.stop();
    showLoading(true);
    setTimeout(() => {
        indiceFrase++;
        if (indiceFrase >= frases.length) {
            if (tempoTotalJogador1 < tempoTotalJogador2) {
                showAlert(`Parab√©ns, Jogador 1! Voc√™ venceu com um tempo total de ${Math.round(tempoTotalJogador1 / 1000)}s contra ${Math.round(tempoTotalJogador2 / 1000)}s do Jogador 2.`);
            } else if (tempoTotalJogador2 < tempoTotalJogador1) {
                showAlert(`Parab√©ns, Jogador 2! Voc√™ venceu com um tempo total de ${Math.round(tempoTotalJogador2 / 1000)}s contra ${Math.round(tempoTotalJogador1 / 1000)}s do Jogador 1.`);
            } else {
                showAlert(`Empate! Ambos os jogadores terminaram a li√ß√£o no mesmo tempo de ${Math.round(tempoTotalJogador1 / 1000)}s.`);
            }
            indiceFrase = 0;
            tempoTotalJogador1 = 0;
            tempoTotalJogador2 = 0;
        }
        
        fraseAtual = frases[indiceFrase];
        palavrasEmbaralhadas = embaralharPalavras(fraseAtual.texto);
        palavrasClicadas = [];
        fraseAcertada = false;
        mostrarTraducao = false;
        
        criarPalavras();
        atualizarFrase();
        atualizarPlacares();
        
        jogadorDaVez = (Math.random() < 0.5) ? 1 : 2;
        console.log(`Iniciando a pr√≥xima rodada. Jogador ${jogadorDaVez} come√ßa.`);
        
        reproduzirTrechoAtual();
        showLoading(false);
        
        tempoInicioTurno = performance.now();
        if (jogadorDaVez === 1) {
            player1Clock.start();
        } else {
            player2Clock.start();
        }
    }, 1500);
}

// FUN√á√ÉO ATUALIZADA: Inicializar a aplica√ß√£o
function init() {
    initializeMenuButtons();
    player1Clock = createClock('clock-face1');
    player2Clock = createClock('clock-face2');
    document.getElementById('current-lesson').textContent = "Nome da Li√ß√£o";
    const urlParams = new URLSearchParams(window.location.search);
    const lessonParam = urlParams.get('lesson');
    if (lessonParam !== null && !isNaN(lessonParam) && lessons[parseInt(lessonParam)]) {
        loadLesson(parseInt(lessonParam));
    } else {
        setTimeout(() => {
            toggleMenu();
        }, 500);
    }
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const menuOverlay = document.getElementById('menu-overlay');
            if (menuOverlay.classList.contains('active')) {
                toggleMenu();
            }
        }
        if (event.code === 'Space' && !event.target.matches('input, textarea')) {
            event.preventDefault();
            if (playerReady && videoElement.paused) {
                reproduzirTrechoAtual();
            } else {
                videoElement.pause();
                pararMonitorTempo();
            }
        }
        if (event.key === 'Enter') {
            const avancarBtn = document.getElementById('avancar');
            if (avancarBtn.style.display !== 'none') {
                avancarBtn.click();
            }
        }
    });
    videoElement.addEventListener('ended', function() {
        pararMonitorTempo();
    });
    const lastLessonIndex = localStorage.getItem('lastLessonIndex');
    if (lastLessonIndex !== null && !isNaN(lastLessonIndex) && lessons[parseInt(lastLessonIndex)]) {
        setTimeout(() => {
            const carregarUltimaLicao = confirm(`Deseja carregar a √∫ltima li√ß√£o acessada? (${lessons[parseInt(lastLessonIndex)].name})`);
            if (carregarUltimaLicao) {
                loadLesson(parseInt(lastLessonIndex));
            }
        }, 1000);
    }
}

// Fun√ß√£o para salvar o progresso do usu√°rio no localStorage
function salvarProgresso() {
    if (!currentLessonName) return;
    const progressoData = {
        lessonName: currentLessonName,
        fraseIndex: indiceFrase,
        tempoTotalJogador1: tempoTotalJogador1,
        tempoTotalJogador2: tempoTotalJogador2,
        timestamp: new Date().getTime()
    };
    localStorage.setItem('listeningProProgresso', JSON.stringify(progressoData));
}

// Fun√ß√£o para carregar o progresso salvo
function carregarProgresso() {
    const progressoSalvo = localStorage.getItem('listeningProProgresso');
    if (!progressoSalvo) return null;
    try {
        return JSON.parse(progressoSalvo);
    } catch (e) {
        console.error("Erro ao carregar progresso:", e);
        return null;
    }
}

// Fun√ß√£o para verificar se h√° progresso salvo para a li√ß√£o atual
function verificarProgressoLicao(lessonName) {
    const progresso = carregarProgresso();
    if (!progresso || progresso.lessonName !== lessonName) return false;
    const agora = new Date().getTime();
    const diferenca = agora - progresso.timestamp;
    const diasDiferenca = diferenca / (1000 * 60 * 60 * 24);
    return diasDiferenca < 7;
}

// Inicializar a aplica√ß√£o quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', init);
		</script>
	</body>
</html>
