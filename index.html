<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpeedPhrase</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: Arial, sans-serif; 
      background: #f9f9f9; 
      padding: 0;
      margin: 0;
    }
    
    /* Header Styles */
    .main-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .nav-button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background 0.2s;
    }
    
    .nav-button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .header-center {
      flex: 1;
      text-align: center;
    }
    
    .header-title {
      margin: 0;
      font-size: 1.5em;
      font-weight: bold;
    }
    
    .exercise-status {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 5px;
    }
    
    .timer-badge, .progress-badge {
      background: rgba(255,255,255,0.2);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Main Content */
    main {
      padding-top: 80px;
      padding-bottom: 80px;
      min-height: 100vh;
    }
    
    /* Game Mode Selection */
    .game-mode-container {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      text-align: center;
    }
    
    .mode-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .mode-button {
      background: white;
      border: 2px solid #ddd;
      border-radius: 15px;
      padding: 30px 25px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-width: 200px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .mode-button:hover {
      border-color: #667eea;
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .mode-icon {
      font-size: 3em;
    }
    
    .mode-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }
    
    .mode-description {
      color: #666;
      font-size: 0.9em;
    }
    
    /* Lesson Grid */
    .video-grid-container {
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .video-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    
    .video-card {
      background: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 12px;
      width: 250px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s;
      text-align: center;
    }
    
    .video-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-color: #667eea;
    }
    
    /* Exercise Styles */
    .video-container, .words-container, .formed-sentence, .controls { 
      margin: 20px auto;
      max-width: 800px;
      text-align: center;
    }
    
    .word { 
      display: inline-block; 
      margin: 5px; 
      padding: 10px 15px; 
      background: #fff;
      border: 2px solid #eee;
      border-radius: 8px; 
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .word:hover {
      border-color: #667eea;
      transform: scale(1.05);
    }
    
    .word.correct { 
      background-color: #c8f7c5; 
      border-color: #4caf50;
      cursor: default;
    }
    
    .word.incorrect { 
      background-color: #f7c5c5; 
      border-color: #f44336;
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .formed-sentence { 
      font-weight: bold; 
      font-size: 1.2em;
      background: white;
      padding: 15px;
      border-radius: 10px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    button { 
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s;
      margin: 5px;
    }
    
    button:hover {
      background: #5a6fd8;
    }
    
    #video {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    /* Multiplayer Styles */
    .multiplayer-container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    
    .match-status {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }
    
    .players-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    
    .player-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 4px solid #667eea;
    }
    
    .player-card.current-player {
      border-left-color: #4caf50;
      background: #f8fff8;
    }
    
    .player-progress {
      margin: 10px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background: #eee;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #667eea;
      transition: width 0.3s;
      border-radius: 5px;
    }
    
    /* Footer */
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      padding: 15px;
      text-align: center;
      border-top: 2px solid #eee;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    footer button {
      background: #f5f5f5;
      color: #333;
      border: none;
      padding: 10px 15px;
      margin: 0 5px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }
    
    footer button:hover {
      background: #667eea;
      color: white;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .mode-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .players-grid {
        grid-template-columns: 1fr;
      }
      
      .word {
        margin: 3px;
        padding: 8px 12px;
        font-size: 0.9em;
      }
      
      #video {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<main style="padding-bottom: 80px;">
  <!-- Header fixo com navega√ß√£o -->
  <header id="mainHeader" class="main-header">
    <nav class="header-nav">
      <button id="homeBtn" class="nav-button home-button" onclick="NavigationController.goHome()">
        <span class="nav-icon">üè†</span>
        <span class="nav-text">Home</span>
      </button>
      
      <button id="backBtn" class="nav-button back-button hidden" onclick="NavigationController.goBack()">
        <span class="nav-icon">‚Üê</span>
        <span class="nav-text">Voltar</span>
      </button>
      
      <div class="header-center">
        <h1 id="headerTitle" class="header-title">SpeedPhrase</h1>
        <div id="exerciseStatus" class="exercise-status hidden">
          <span id="timer" class="timer-badge"></span>
          <span id="progressBadge" class="progress-badge"></span>
        </div>
      </div>
      
      <button id="settingsBtn" class="nav-button settings-button" onclick="NavigationController.openSettings()">
        <span class="nav-icon">‚öôÔ∏è</span>
      </button>
    </nav>
  </header>
  
  <!-- Se√ß√£o de sele√ß√£o de modo de jogo -->
  <section id="gameModeSection" class="game-mode-container">
    <h2>Escolha o modo de jogo</h2>
    <div class="mode-buttons">
      <button class="mode-button" onclick="selectGameMode('solo')">
        <span class="mode-icon">üéØ</span>
        <span class="mode-title">Solo</span>
        <span class="mode-description">Jogue no seu pr√≥prio ritmo</span>
      </button>
      <button class="mode-button" onclick="selectGameMode('multiplayer')">
        <span class="mode-icon">üë•</span>
        <span class="mode-title">Multiplayer</span>
        <span class="mode-description">Desafie outros jogadores</span>
      </button>
    </div>
  </section>
  
  <!-- Se√ß√£o multiplayer -->
  <section id="multiplayerSection" class="multiplayer-container hidden">
    <div id="matchStatus" class="match-status">
      <h3 id="statusTitle">Procurando advers√°rio...</h3>
      <p id="statusMessage">Aguarde enquanto procuramos um oponente</p>
      <button id="cancelSearch" onclick="cancelMatchmaking()">Cancelar</button>
    </div>
    
    <div id="playersGrid" class="players-grid hidden">
      <!-- Players cards ser√£o inseridos aqui dinamicamente -->
    </div>
    
    <div id="multiplayerControls" class="hidden" style="text-align: center;">
      <button id="readyButton" onclick="toggleReady()">Estou Pronto!</button>
      <button id="leaveMatchButton" onclick="leaveCurrentMatch()">Sair da Partida</button>
    </div>
  </section>
  
  <!-- Se√ß√µes de li√ß√µes -->
  <section id="avulsas-section" class="video-grid-container">
    <div id="avulsas-grid" class="video-grid"></div>
  </section>

  <section id="trilha-section" class="video-grid-container">
    <div id="trilha-grid" class="video-grid"></div>
  </section>

  <!-- Se√ß√£o do v√≠deo e controles -->
  <section id="videoSection" style="margin-top: 0;">
    <div class="video-container">
      <video id="video" width="70%" height="340" controls>
        <source src="https://f005.backblazeb2.com/file/Avulsas/Im_Gonna_Be_-_500_Miles.mp4" type="video/mp4" />
      </video>
    </div>
    <div class="controls" style="margin-top: 10px;">
      <button onclick="playCurrentSubtitle()">‚ñ∂Ô∏è Tocar trecho</button>
    </div>
  </section>

  <!-- Se√ß√£o da frase formada -->
  <section id="formedSentenceSection" style="margin-top: 20px;">
    <div class="formed-sentence" id="formedSentence"></div>
  </section>

  <!-- Se√ß√£o das palavras embaralhadas -->
  <section id="shuffledWordsSection" style="margin-top: 20px;">
    <div class="words-container" id="shuffledWords"></div>
  </section>
</main>

<footer style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #fff;
  padding: 10px;
  text-align: center;
  border-top: 1px solid #ccc;
  z-index: 1000;
">
  <nav>
    <button onclick="goToSearch()">üîç Pesquisar</button>
    <button onclick="goToAvulsas()">üìÇ Avulsas</button>
    <button onclick="goToTrilha()">üõ§Ô∏è Trilha</button>
  </nav>
</footer>

  <script>
//=============================
// Estado da Aplica√ß√£o
//=============================
let subtitles = [];
let currentIndex = 0;
let formedWords = [];
let currentGameMode = null;

//=============================
// Estado de Timer
//=============================
let startTime = 0;
let totalElapsedTime = 0;
let totalEstimatedTime = 0;
let timerInterval = null;

//=============================
// Lessons
//=============================
const avulsasLessons = [{
    name: "I'm Gonna Be - 500 Miles.mp4",
    srtUrl: "https://files.catbox.moe/wt145j.srt",
    videoUrl: "https://files.catbox.moe/8pzqza.mp4"
}];

const trilhaLessons = [{
    name: "Chapter 1 - Welcome & Nationalities",
    srtUrl: "https://files.catbox.moe/wt145j.srt",
    videoUrl: "https://files.catbox.moe/8pzqza.mp4"
}];

//=============================
// Game Mode Selection
//=============================
function selectGameMode(mode) {
    currentGameMode = mode;
    console.log(`Modo selecionado: ${mode}`);
    
    NavigationController.navigateTo('lessonSelection');
    NavigationController.showLessonSelection();
}

//=============================
// Navigation Controller
//=============================
const NavigationController = {
  currentSection: 'gameMode',
  navigationStack: [],
  
  // Simplificar configura√ß√µes - tratar li√ß√µes como estado √∫nico
  sectionConfig: {
    gameMode: {
      title: 'SpeedPhrase',
      showBack: false,
      showHome: true,
      showFooter: false
    },
    lessonSelection: {
      title:'',
      showBack: true,
      showHome: true,
      showFooter: true
    },
    exercise: {
      title: 'Exerc√≠cio',
      showBack: true,
      showHome: true,
      showFooter: false
    }
  },


  // incluir limpeza
  // controlar footer
  navigateTo(section, pushToStack = true) {
    // Se saindo de um exerc√≠cio, pausar tudo
    if (this.currentSection === 'exercise' && section !== 'exercise') {
      this.pauseAllResources();
      this.hideExerciseStatus();
    }

    if (pushToStack && this.currentSection !== section) {
      this.navigationStack.push(this.currentSection);
    }
    
    this.currentSection = section;
    this.updateHeader();
    this.updateFooterVisibility(); // Adicionar controle do footer
  },
    
  // Nova fun√ß√£o para controlar footer
  updateFooterVisibility() {
    const config = this.sectionConfig[this.currentSection];
    if (config && config.showFooter) {
      showFooter();
    } else {
      hideFooter();
    }
  },
  
  // Voltar
  // incluir limpeza quando necess√°rio
  // manter estado de li√ß√µes
  goBack() {
    if (this.currentSection === 'exercise') {
      this.pauseAllResources();
      this.hideExerciseStatus();
      // Voltar sempre para sele√ß√£o de li√ß√µes (com footer)
      this.navigateToSection('lessonSelection');
      return;
    }

    if (this.navigationStack.length > 0) {
      const previousSection = this.navigationStack.pop();
      this.navigateToSection(previousSection);
    }
  },
    
  // Modificar goHome para garantir limpeza completa
  goHome() {
    this.pauseAllResources(); // Pausar tudo antes de ir para home
    this.hideExerciseStatus();
    this.navigationStack = [];
    this.currentSection = 'gameMode';
    this.showGameModeSelection();
    this.updateHeader();
  },

  // Abrir configura√ß√µes
  openSettings() {
    alert('‚öôÔ∏è Configura√ß√µes em desenvolvimento');
  },

  // Atualizar header baseado na se√ß√£o atual
    updateHeader() {
      const config = this.sectionConfig[this.currentSection];
      if (!config) return;
    
      // Obter t√≠tulo din√¢mico para lessonSelection
      let title = config.title;
      if (this.currentSection === 'lessonSelection') {
        title = this.getLessonSelectionTitle();
      }
    
      // Atualizar t√≠tulo
      document.getElementById('headerTitle').textContent = title;
    
      // Mostrar/esconder bot√£o voltar
      const backBtn = document.getElementById('backBtn');
      if (config.showBack && this.navigationStack.length > 0) {
        backBtn.classList.remove('hidden');
      } else {
        backBtn.classList.add('hidden');
      }
    },
    
  // Navegar para se√ß√£o espec√≠fica
  navigateToSection(section) {
    switch(section) {
      case 'gameMode':
        this.showGameModeSelection();
        break;
      case 'lessonSelection':
        // Manter a √∫ltima categoria visitada ou ir para avulsas por padr√£o
        this.showLessonSelection();
        break;
      default:
        this.showGameModeSelection();
    }
    this.currentSection = section;
    this.updateHeader();
    this.updateFooterVisibility();
  },

  // Mostrar sele√ß√£o de modo
  showGameModeSelection() {
    hideAllSections();
    hideFooter();
    document.getElementById('gameModeSection').style.display = '';
  },
  
    showExerciseStatus() {
      document.getElementById('exerciseStatus').classList.remove('hidden');
      this.updateProgressBadge();
    },
    
    hideExerciseStatus() {
      document.getElementById('exerciseStatus').classList.add('hidden');
    },
    
    updateProgressBadge() {
      const badge = document.getElementById('progressBadge');
      if (subtitles.length > 0) {
        badge.textContent = `${currentIndex + 1}/${subtitles.length}`;
      }
    },
    showLessonSelection() {
      hideAllSections();
      
      // Sempre mostrar avulsas quando vem da sele√ß√£o de modo
      document.getElementById('avulsas-section').style.display = '';
      generateVideoCards(avulsasLessons, 'avulsas-grid', handleLessonClick);
      
      // Definir avulsas como categoria atual se n√£o havia nenhuma
      if (!localStorage.getItem('lastLessonCategory')) {
        localStorage.setItem('lastLessonCategory', 'avulsas');
      }
    },
    
  // Pausar todos os recursos ativos
  pauseAllResources() {
    this.pauseVideo();
    this.stopTimers();
    this.resetExerciseState();
  },

  // Pausar v√≠deo
  pauseVideo() {
    const video = document.getElementById('video');
    if (video && !video.paused) {
      video.pause();
      console.log('üé¨ V√≠deo pausado pela navega√ß√£o');
    }
  },

  // Parar todos os timers
  stopTimers() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
      console.log('‚è±Ô∏è Timer de performance interrompido');
    }
  },

  // Resetar estado do exerc√≠cio
  resetExerciseState() {
    formedWords = [];
    startTime = 0;
    
    // Limpar display do timer
    const timerElement = document.getElementById('timer');
    if (timerElement) {
      timerElement.innerHTML = '';
    }
  },

    getLessonSelectionTitle() {
      const mode = currentGameMode ? 
        currentGameMode.charAt(0).toUpperCase() + currentGameMode.slice(1) : 
        '';
      const category = localStorage.getItem('lastLessonCategory') || 'avulsas';
      const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
      
      return `${mode} - ${categoryName}`;
    }
};

//=============================
// Fun√ß√£o: Carrega e Processa o SRT
//=============================
async function loadSrt(url) {
    const res = await fetch(url);
    const text = await res.text();
    return parseSRT(text);
}

//=============================
// Fun√ß√£o: Parser SRT simples
//=============================
function parseSRT(srt) {
    const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n{2,}|$)/g;
    let result = [];
    let match;
    while ((match = regex.exec(srt)) !== null) {
        result.push({
            index: Number(match[1]),
            start: timeToSeconds(match[2]),
            end: timeToSeconds(match[3]),
            text: match[4].replace(/\n/g, ' ').trim()
        });
    }
    return result;
}

//=============================
// Fun√ß√£o: Converte tempo SRT para segundos
//=============================
function timeToSeconds(time) {
    const [h, m, s] = time.replace(',', '.').split(':');
    return parseFloat(h) * 3600 + parseFloat(m) * 60 + parseFloat(s);
}

//=============================
// Fun√ß√£o: Embaralha palavras
//=============================
function shuffleWords(text) {
    const words = text.split(' ');
    for (let i = words.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [words[i], words[j]] = [words[j], words[i]];
    }
    return words;
}

//=============================
// Fun√ß√£o: Exibe palavras embaralhadas
//=============================
function displayShuffledWords(words, original) {
    const container = document.getElementById('shuffledWords');
    container.innerHTML = '';
    formedWords = [];

    words.forEach(word => {
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = word;
        span.onclick = () => handleWordClick(word, span, original);
        container.appendChild(span);
    });

    updateFormedSentence();
}

//=============================
// Fun√ß√£o principal de clique
//=============================
function handleWordClick(word, element, original) {
    if (isCorrectWord(word, original)) {
        processCorrectWord(word, element);
        clearIncorrectWords();
        updateDisplay(); // Atualiza ap√≥s adicionar palavra correta
    } else {
        markWordAsIncorrect(element);
    }

    updateFormedSentence();
    checkIfSentenceIsComplete(original);
}

//=============================
// Verifica se palavra est√° correta
//=============================
function isCorrectWord(word, original) {
    const expectedWords = original.split(' ');
    const currentIndex = formedWords.length;
    return word === expectedWords[currentIndex];
}

//=============================
// Processa palavra correta
//=============================
function processCorrectWord(word, element) {
    formedWords.push(word);
    element.classList.add('correct');
    element.onclick = null;
}

//=============================
// Marca palavra incorreta (n√£o adiciona √† frase)
//=============================
function markWordAsIncorrect(element) {
    element.classList.add('incorrect');
}

//=============================
// Limpa marca√ß√µes incorretas
//=============================
function clearIncorrectWords() {
    const incorrectElements = document.querySelectorAll('.word.incorrect');
    incorrectElements.forEach(el => {
        el.classList.remove('incorrect');
    });
}

//=============================
// Verifica se frase est√° completa e correta
//=============================
async function checkIfSentenceIsComplete(original) {
    if (formedWords.join(' ') === original) {
        // Parar timer antes de qualquer a√ß√£o
        NavigationController.stopTimers();
        
        const timeUsed = stopTimerAndGetElapsed();
        console.log(`‚è±Ô∏è Tempo para essa frase: ${timeUsed.toFixed(2)}s`);

        // Toca o v√≠deo e aguarda terminar
        console.log('üé¨ Reproduzindo trecho da frase completada...');
        await playCurrentSubtitleAndWait();
        
        // Verificar se ainda estamos na se√ß√£o de exerc√≠cio antes de continuar
        if (NavigationController.currentSection !== 'exercise') {
            console.log('‚ö†Ô∏è Usu√°rio saiu do exerc√≠cio, interrompendo fluxo');
            return;
        }
        
        // S√≥ depois que o v√≠deo terminou, avan√ßa
        if (currentIndex < subtitles.length - 1) {
            nextPhrase();
        } else {
            alert('üéâ Todas as frases completas! Li√ß√£o finalizada.');
            displayTotalTime();
        }
    }
}

//=============================
// Fun√ß√£o: Atualiza frase formada
//=============================
function updateFormedSentence() {
    document.getElementById('formedSentence').textContent = formedWords.join(' ');
}

//=============================
// Fun√ß√£o: Avan√ßa para pr√≥xima frase
//=============================
function nextPhrase() {
    currentIndex++;
    console.log(`üìù Avan√ßando para frase ${currentIndex + 1}/${subtitles.length}`);
    
    if (currentIndex < subtitles.length) {
        prepareCurrentSubtitle();
    } else {
        alert("‚úÖ Fim das legendas!");
        displayTotalTime();
    }
}

//=============================
// Fun√ß√£o: Prepara legenda atual
//=============================
function prepareCurrentSubtitle() {
    // Verificar se ainda estamos no exerc√≠cio
    if (NavigationController.currentSection !== 'exercise') {
        console.log('‚ö†Ô∏è N√£o estamos mais no exerc√≠cio, cancelando prepara√ß√£o');
        return;
    }

    const sub = subtitles[currentIndex];
    console.log(`üé¨ Preparando frase ${currentIndex + 1}: "${sub.text}"`);
    
    // Limpar estado anterior
    formedWords = [];
    NavigationController.stopTimers(); // Usar m√©todo centralizado
    
    const shuffled = shuffleWords(sub.text);
    displayShuffledWords(shuffled, sub.text);

    startTimer();
    startPerformanceUpdate();
    NavigationController.updateProgressBadge();
    
    // Toca o trecho inicial (sem aguardar)
    playCurrentSubtitle();
}

//=============================
// Inicia a contagem de tempo real e a atualiza√ß√£o da performance
//=============================
function startPerformanceUpdate() {
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        updateDisplay();
    }, 1000);
}

//=============================
// Fun√ß√£o para atualizar o display da performance (Chamada por setInterval e click)
//=============================
function updateDisplay() {
    // Verificar se ainda estamos no exerc√≠cio
    if (NavigationController.currentSection !== 'exercise') {
        NavigationController.stopTimers();
        return;
    }

    const display = document.getElementById('timer');
    if (!display) return;

    const sub = subtitles[currentIndex];
    const sentenceEstimatedTime = getTimeLimitForSentence(sub.text);
    const elapsed = (performance.now() - startTime) / 1000;
    
    // Calcula a proje√ß√£o: tempo j√° gasto + tempo restante baseado na performance atual
    const wordsCompleted = formedWords.length;
    const totalWords = sub.text.split(' ').length;
    
    let projectedTotalTime;
    if (wordsCompleted > 0) {
        const timePerCompletedWord = elapsed / wordsCompleted;
        const remainingWords = totalWords - wordsCompleted;
        projectedTotalTime = elapsed + (remainingWords * timePerCompletedWord);
    } else {
        // Se ainda n√£o completou nenhuma palavra, usa o tempo atual como base
        projectedTotalTime = elapsed * (totalWords / Math.max(1, wordsCompleted || 0.1));
    }
    
    // Calcula a performance: quanto melhor que o estimado
    let performanceValue = (sentenceEstimatedTime / projectedTotalTime) * 100;
    
    // Garante que n√£o seja infinito ou NaN
    if (!isFinite(performanceValue) || performanceValue > 1000) {
        performanceValue = 100;
    }

    let emoji = 'üëç';
    if (performanceValue < 75) {
        emoji = 'üê¢';
    } else if (performanceValue < 100) {
        emoji = 'ü§î';
    } else if (performanceValue > 125) {
        emoji = 'üöÄ';
    }

    display.innerHTML = `<span style="font-weight: bold; color: ${performanceValue >= 100 ? 'green' : 'red'};">${performanceValue.toFixed(2)}%</span> ${emoji}`;
}

//=============================
// Nova fun√ß√£o que reproduz o v√≠deo e retorna uma Promise
//=============================
function playCurrentSubtitleAndWait() {
    const video = document.getElementById('video');
    const sub = subtitles[currentIndex];
    
    if (!video || !sub) {
        console.error('‚ùå V√≠deo ou legenda n√£o encontrados');
        return Promise.resolve();
    }

    return new Promise((resolve) => {
        console.log(`‚ñ∂Ô∏è Reproduzindo trecho: ${sub.start.toFixed(2)}s - ${sub.end.toFixed(2)}s`);
        
        // Para o v√≠deo antes de reposicionar
        video.pause();
        video.currentTime = sub.start;
        
        // Fun√ß√£o para monitorar o fim do trecho
        function checkVideoEnd() {
            if (video.currentTime >= sub.end) {
                video.pause();
                console.log(`‚è∏Ô∏è V√≠deo pausado em ${sub.end.toFixed(2)}s - Prosseguindo...`);
                resolve();
            } else if (!video.paused) {
                if (typeof video.requestVideoFrameCallback === 'function') {
                    video.requestVideoFrameCallback(checkVideoEnd);
                } else {
                    requestAnimationFrame(checkVideoEnd);
                }
            }
        }
        
        // Inicia reprodu√ß√£o
        const playPromise = video.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log(`‚úÖ V√≠deo iniciado em ${sub.start.toFixed(2)}s`);
                checkVideoEnd();
            }).catch(error => {
                console.error('‚ùå Erro ao reproduzir v√≠deo:', error);
                resolve(); // Resolve mesmo com erro para n√£o travar
            });
        } else {
            checkVideoEnd();
        }
    });
}

//=============================
// Fun√ß√£o principal que toca o v√≠deo (usada pelo bot√£o)
//=============================
function playCurrentSubtitle() {
    playCurrentSubtitleAndWait(); // N√£o precisa aguardar quando chamado pelo bot√£o
}

//=============================
// Bloco de Timer (Revisado)
//=============================
function getTimeLimitForSentence(sentence) {
    const characterCount = sentence.trim().replace(/\s/g, '').length;
    const timePerCharacter = 0.2;
    return characterCount * timePerCharacter;
}

//=============================
// Inicia contagem de tempo real do usu√°rio
//=============================
function startTimer() {
    startTime = performance.now();
}

//=============================
// Calcula tempo gasto em segundos
//=============================
function stopTimerAndGetElapsed() {
    const endTime = performance.now();
    const elapsed = (endTime - startTime) / 1000;
    totalElapsedTime += elapsed;
    return elapsed;
}

//=============================
// Exibe o tempo total acumulado
//=============================
function displayTotalTime() {
    const totalPerformance = (totalEstimatedTime / totalElapsedTime) * 100;
    alert(`Li√ß√£o completa! üèÅ
Tempo total: ${totalElapsedTime.toFixed(2)}s
Desempenho geral: ${totalPerformance.toFixed(2)}%`);
}

//=============================
// Bloco de Footer
//=============================
function showFooter() {
    const footer = document.querySelector('footer');
    if (footer) footer.style.display = 'block';
}

function hideFooter() {
    const footer = document.querySelector('footer');
    if (footer) footer.style.display = 'none';
}

function goToSearch() {
    // Fun√ß√£o para futuro desenvolvimento
    alert('üîç Fun√ß√£o de pesquisa em desenvolvimento');
}

function goToAvulsas() {
    if (!currentGameMode) return;
    
    if (NavigationController.currentSection === 'exercise') {
        NavigationController.pauseAllResources();
    }
    
    hideAllSections();
    document.getElementById('avulsas-section').style.display = '';
    generateVideoCards(avulsasLessons, 'avulsas-grid', handleLessonClick);
    
    localStorage.setItem('lastLessonCategory', 'avulsas');
    NavigationController.updateHeader();
    
    if (NavigationController.currentSection !== 'lessonSelection') {
        NavigationController.navigateTo('lessonSelection', false);
    }
}

function goToTrilha() {
    if (!currentGameMode) return;
    
    if (NavigationController.currentSection === 'exercise') {
        NavigationController.pauseAllResources();
    }
    
    hideAllSections();
    document.getElementById('trilha-section').style.display = '';
    generateVideoCards(trilhaLessons, 'trilha-grid', handleLessonClick);
    
    localStorage.setItem('lastLessonCategory', 'trilha');
    NavigationController.updateHeader();
    
    if (NavigationController.currentSection !== 'lessonSelection') {
        NavigationController.navigateTo('lessonSelection', false);
    }
}

//=============================
// Bloco de Ocultar/Mostrar se√ß√µes
//=============================
function hideAllSections() {
    const sectionsToHide = [
        'gameModeSection',  // Adicionar esta linha
        'avulsas-section',
        'trilha-section',
        'videoSection',
        'formedSentenceSection',
        'shuffledWordsSection'
    ];

    sectionsToHide.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
}

//=========================
// Bloco lessons cards
//=========================
function createVideoCard(lesson, onClick) {
    const card = document.createElement('div');
    card.className = 'video-card';
    card.textContent = lesson.name;
    card.onclick = () => onClick(lesson);
    return card;
}

//==========================================
// Gera grid de cards dentro do container
//==========================================
function generateVideoCards(lessons, containerId, onClick) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';
    lessons.forEach(lesson => {
        const card = createVideoCard(lesson, onClick);
        container.appendChild(card);
    });
}

//==========================================
// Carrega li√ß√µes nas se√ß√µes correspondentes
//==========================================
function loadAllLessons() {
    generateVideoCards(avulsasLessons, 'avulsas-grid', handleLessonClick);
    generateVideoCards(trilhaLessons, 'trilha-grid', handleLessonClick);
}

//=============================
// Clique no card de li√ß√£o
//=============================
async function handleLessonClick(lesson) {
    console.log('Li√ß√£o selecionada:', lesson);
    
    hideAllSections();
    hideFooter();
    
    // Centralizar o conte√∫do do jogo
    const main = document.querySelector('main');
    main.style.maxWidth = '800px';
    main.style.margin = '0 auto';
    main.style.paddingTop = '20px';
    
    // Mostrar se√ß√µes do exerc√≠cio
    document.getElementById('videoSection').style.display = '';
    document.getElementById('formedSentenceSection').style.display = '';
    document.getElementById('shuffledWordsSection').style.display = '';
    // Configurar header do exerc√≠cio
    NavigationController.sectionConfig.exercise.title = lesson.name;
    NavigationController.navigateTo('exercise');
    // Mostrar status do exerc√≠cio
    NavigationController.showExerciseStatus();
    
    // Configurar t√≠tulo com nome da li√ß√£o
    NavigationController.sectionConfig.exercise.title = `${lesson.name}`;
    NavigationController.navigateTo('exercise');

    const video = document.getElementById('video');
    video.src = lesson.videoUrl;
    
    subtitles = await loadSrt(lesson.srtUrl);
    totalEstimatedTime = subtitles.reduce((sum, sub) => {
        return sum + getTimeLimitForSentence(sub.text);
    }, 0);

    totalElapsedTime = 0;
    console.log(`‚è±Ô∏è Tempo total estimado para a li√ß√£o: ${totalEstimatedTime.toFixed(2)}s`);
    currentIndex = 0;
    prepareCurrentSubtitle();
}


//=============================
// Inicializa√ß√£o
//=============================
document.addEventListener('DOMContentLoaded', () => {
    loadAllLessons();
    hideFooter();
    NavigationController.showGameModeSelection();
    NavigationController.updateHeader();
});

// Adicionar listener para quando a p√°gina √© fechada/recarregada
window.addEventListener('beforeunload', () => {
    NavigationController.pauseAllResources();
});

// Adicionar listener para visibilidade da p√°gina
document.addEventListener('visibilitychange', () => {
    if (document.hidden && NavigationController.currentSection === 'exercise') {
        NavigationController.pauseVideo();
    }
});
</script>
</body>
</html>
